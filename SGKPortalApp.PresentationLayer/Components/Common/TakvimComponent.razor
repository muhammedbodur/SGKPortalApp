@using SGKPortalApp.BusinessObjectLayer.DTOs.Response.Common
@using SGKPortalApp.BusinessObjectLayer.DTOs.Response.PdksIslemleri
@using SGKPortalApp.BusinessObjectLayer.DTOs.Request.PdksIslemleri
@using SGKPortalApp.BusinessObjectLayer.Enums.Common
@using SGKPortalApp.BusinessObjectLayer.Enums.PdksIslemleri
@using Microsoft.AspNetCore.Components.Authorization
@using System.Text.Json
@using SGKPortalApp.PresentationLayer.Services.ApiServices.Interfaces.Pdks
@inject IResmiTatilApiService _resmiTatilService
@inject IPersonelMesaiApiService _mesaiService
@inject IIzinMazeretTalepApiService _izinMazeretService
@inject AuthenticationStateProvider _authStateProvider
@inject IJSRuntime JSRuntime

@if (ShowSidebar)
{
    <!-- FULL PAGE MODE -->
    <div class="card app-calendar-wrapper">
        <div class="d-flex">
            <!-- Calendar Sidebar -->
            <div class="app-calendar-sidebar border-end" style="flex: 0 0 260px;">
                <div class="border-bottom p-4">
                    <div class="d-grid gap-2">
                        <a href="/common/takvim/manage" class="btn btn-primary">
                            <i class="bx bx-plus me-1"></i>
                            <span class="align-middle">Yeni Tatil Ekle</span>
                        </a>
                        <button class="btn btn-outline-secondary" @onclick="SyncCalendar" disabled="@IsLoading">
                            <i class="bx bx-sync me-1"></i>
                            <span class="align-middle">Senkronize Et</span>
                        </button>
                    </div>
                </div>

                <div class="p-4">
                    <!-- Year Selector -->
                    <div class="mb-4">
                        <label class="form-label">YÄ±l SeÃ§in</label>
                        <select class="form-select" @bind="SelectedYear" @bind:event="onchange">
                            @for (int year = DateTime.Now.Year - 2; year <= DateTime.Now.Year + 5; year++)
                            {
                                <option value="@year">@year</option>
                            }
                        </select>
                    </div>

                    <hr class="my-4">

                    <!-- Statistics -->
                    <div class="mb-4">
                        <small class="text-small text-muted text-uppercase">Ä°statistikler</small>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Resmi Tatiller:</span>
                                <strong class="text-primary">@Tatiller.Count(t => t.TatilTipi == TatilTipi.SabitTatil)</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Dini Bayram ve GÃ¼nler:</span>
                                <strong class="text-success">@Tatiller.Count(t => t.TatilTipi == TatilTipi.DiniTatil)</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="mb-4">
                        <small class="text-small text-muted text-uppercase">Filtre</small>
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="filterSabit" 
                                   @bind="FilterSabitTatil" @bind:event="onchange">
                            <label class="form-check-label" for="filterSabit">
                                Resmi Tatiller
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="filterDini" 
                                   @bind="FilterDiniTatil" @bind:event="onchange">
                            <label class="form-check-label" for="filterDini">
                                Dini Bayram ve GÃ¼nler
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="filterMesai" 
                                   @bind="FilterMesai" @bind:event="onchange">
                            <label class="form-check-label" for="filterMesai">
                                <i class="bx bx-time-five"></i> GiriÅŸ/Ã‡Ä±kÄ±ÅŸ
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="filterIzin" 
                                   @bind="FilterIzinMazeret" @bind:event="onchange">
                            <label class="form-check-label" for="filterIzin">
                                <i class="bx bx-calendar"></i> Ä°zin/Mazeret
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Content (Full Page) -->
            <div class="app-calendar-content" style="flex: 1;">
                <div class="card-body pb-0">
                    @if (IsLoading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">YÃ¼kleniyor...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- FullCalendar -->
                        <div id="@CalendarId"></div>
                    }
                </div>
            </div>
        </div>
    </div>
}
else
{
    <!-- WIDGET MODE -->
    @if (IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">YÃ¼kleniyor...</span>
            </div>
        </div>
    }
    else
    {
        <!-- FullCalendar Widget -->
        <div id="@CalendarId"></div>
    }
}

@code {
    [Parameter] public bool ShowSidebar { get; set; } = true;
    [Parameter] public string CalendarId { get; set; } = "takvimCalendar";

    private List<ResmiTatilResponseDto> Tatiller { get; set; } = new();
    private List<PersonelMesaiListResponseDto> MesaiKayitlari { get; set; } = new();
    private List<IzinMazeretTalepListResponseDto> IzinMazeretTalepleri { get; set; } = new();
    
    private bool IsLoading { get; set; } = true;
    private string? CurrentUserTc { get; set; }

    // Year selection with auto-reload
    private int _selectedYear = DateTime.Now.Year;
    private int SelectedYear
    {
        get => _selectedYear;
        set
        {
            if (_selectedYear != value)
            {
                _selectedYear = value;
                _ = Task.Run(async () =>
                {
                    await LoadAllData();
                    await RenderCalendar();
                });
            }
        }
    }

    // Filters with auto-reload
    private bool _filterSabitTatil = true;
    private bool FilterSabitTatil
    {
        get => _filterSabitTatil;
        set
        {
            _filterSabitTatil = value;
            _ = RenderCalendar();
        }
    }

    private bool _filterDiniTatil = true;
    private bool FilterDiniTatil
    {
        get => _filterDiniTatil;
        set
        {
            _filterDiniTatil = value;
            _ = RenderCalendar();
        }
    }

    private bool _filterMesai = true;
    private bool FilterMesai
    {
        get => _filterMesai;
        set
        {
            _filterMesai = value;
            _ = RenderCalendar();
        }
    }

    private bool _filterIzinMazeret = true;
    private bool FilterIzinMazeret
    {
        get => _filterIzinMazeret;
        set
        {
            _filterIzinMazeret = value;
            _ = RenderCalendar();
        }
    }

    private bool _firstLoadComplete = false;

    protected override async Task OnInitializedAsync()
    {
        await GetCurrentUserTc();
        await LoadAllData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_firstLoadComplete && !IsLoading)
        {
            _firstLoadComplete = true;
            await Task.Delay(100);
            await RenderCalendar();
        }
    }

    private async Task GetCurrentUserTc()
    {
        try
        {
            var authState = await _authStateProvider.GetAuthenticationStateAsync();
            CurrentUserTc = authState.User.FindFirst("TcKimlikNo")?.Value;
        }
        catch { }
    }

    private async Task LoadAllData()
    {
        IsLoading = true;
        await Task.WhenAll(
            LoadTatiller(),
            LoadMesaiKayitlari(),
            LoadIzinMazeretTalepleri()
        );
        IsLoading = false;
        StateHasChanged();
    }

    private async Task LoadTatiller()
    {
        try
        {
            var result = await _resmiTatilService.GetByYearAsync(SelectedYear);
            if (result.Success && result.Data != null)
            {
                Tatiller = result.Data;
            }
        }
        catch (Exception) { }
    }

    private async Task LoadMesaiKayitlari()
    {
        if (string.IsNullOrEmpty(CurrentUserTc)) return;

        try
        {
            var request = new PersonelMesaiFilterRequestDto
            {
                TcKimlikNo = CurrentUserTc,
                BaslangicTarihi = new DateTime(SelectedYear, 1, 1),
                BitisTarihi = new DateTime(SelectedYear, 12, 31)
            };

            var result = await _mesaiService.GetListeAsync(request);
            if (result.Success && result.Data != null)
            {
                MesaiKayitlari = result.Data;
            }
        }
        catch (Exception) { }
    }

    private async Task LoadIzinMazeretTalepleri()
    {
        if (string.IsNullOrEmpty(CurrentUserTc)) return;

        try
        {
            var result = await _izinMazeretService.GetByPersonelAsync(CurrentUserTc);
            if (result.Success && result.Data != null)
            {
                IzinMazeretTalepleri = result.Data
                    .Where(t =>
                    {
                        if (t.BaslangicTarihi.HasValue)
                            return t.BaslangicTarihi.Value.Year == SelectedYear ||
                                   (t.BitisTarihi.HasValue && t.BitisTarihi.Value.Year == SelectedYear);
                        else if (t.MazeretTarihi.HasValue)
                            return t.MazeretTarihi.Value.Year == SelectedYear;
                        return false;
                    })
                    .ToList();
            }
        }
        catch (Exception) { }
    }

    private async Task RenderCalendar()
    {
        if (IsLoading) return;

        try
        {
            var events = new List<object>();

            // 1. Resmi Tatiller
            if (FilterSabitTatil || FilterDiniTatil)
            {
                var tatilEvents = Tatiller
                    .Where(t =>
                    {
                        // TatilTipi=1 (Dini GÃ¼nler) sadece bilgi amaÃ§lÄ±, tatil deÄŸil - gÃ¶sterme
                        if (t.TatilTipi == TatilTipi.DiniTatil) return false;
                        
                        if (t.TatilTipi == TatilTipi.SabitTatil && !FilterSabitTatil) return false;
                        return true;
                    })
                    .Select(t => new
                    {
                        id = $"tatil-{t.TatilId}",
                        title = t.TatilAdi,
                        start = t.Tarih.ToString("yyyy-MM-dd"),
                        allDay = true,
                        backgroundColor = GetTatilColor(t.TatilTipi),
                        borderColor = GetTatilColor(t.TatilTipi),
                        extendedProps = new
                        {
                            eventType = "tatil",
                            tatilTipi = t.TatilTipiText,
                            aciklama = t.Aciklama
                        }
                    });
                events.AddRange(tatilEvents);
            }

            // 2. Mesai KayÄ±tlarÄ±
            if (FilterMesai)
            {
                var mesaiEvents = MesaiKayitlari
                    .Where(m => m.GirisSaati.HasValue || m.CikisSaati.HasValue)
                    .Select(m => new
                    {
                        id = $"mesai-{m.Tarih:yyyyMMdd}",
                        title = $"{FormatTimeSpan(m.GirisSaati)}",
                        start = m.Tarih.ToString("yyyy-MM-dd"),
                        allDay = false,
                        backgroundColor = GetMesaiColor(m),
                        borderColor = GetMesaiColor(m),
                        extendedProps = new
                        {
                            eventType = "mesai",
                            girisSaati = FormatTimeSpan(m.GirisSaati),
                            cikisSaati = FormatTimeSpan(m.CikisSaati),
                            gecKalma = m.GecKalma,
                            description = $"GiriÅŸ: {FormatTimeSpan(m.GirisSaati)}\nÃ‡Ä±kÄ±ÅŸ: {FormatTimeSpan(m.CikisSaati)}"
                        }
                    });
                events.AddRange(mesaiEvents);
            }

            // 3. Ä°zin/Mazeret Talepleri
            if (FilterIzinMazeret)
            {
                foreach (var talep in IzinMazeretTalepleri)
                {
                    if (talep.Turu == IzinMazeretTipi.Mazeret && talep.MazeretTarihi.HasValue)
                    {
                        events.Add(new
                        {
                            id = $"mazeret-{talep.IzinMazeretTalepId}",
                            title = $"ðŸ“… {talep.TuruAdi}",
                            start = talep.MazeretTarihi.Value.ToString("yyyy-MM-dd"),
                            allDay = false,
                            backgroundColor = GetIzinMazeretColor(talep),
                            borderColor = GetIzinMazeretColor(talep),
                            extendedProps = new
                            {
                                eventType = "mazeret",
                                tur = talep.TuruAdi,
                                saatDilimi = talep.SaatDilimi
                            }
                        });
                    }
                    else if (talep.BaslangicTarihi.HasValue && talep.BitisTarihi.HasValue)
                    {
                        events.Add(new
                        {
                            id = $"izin-{talep.IzinMazeretTalepId}",
                            title = $"ðŸ“… {talep.TuruAdi}",
                            start = talep.BaslangicTarihi.Value.ToString("yyyy-MM-dd"),
                            end = talep.BitisTarihi.Value.AddDays(1).ToString("yyyy-MM-dd"),
                            allDay = true,
                            backgroundColor = GetIzinMazeretColor(talep),
                            borderColor = GetIzinMazeretColor(talep),
                            extendedProps = new
                            {
                                eventType = "izin",
                                tur = talep.TuruAdi,
                                toplamGun = talep.ToplamGun
                            }
                        });
                    }
                }
            }

            var eventsJson = JsonSerializer.Serialize(events);

            // Widget iÃ§in farklÄ± JS fonksiyonu kullan
            var jsFunction = ShowSidebar ? "initTakvimCalendar" : "initTakvimWidgetCalendar";
            await JSRuntime.InvokeVoidAsync(jsFunction, eventsJson, SelectedYear);
        }
        catch (Exception) { }
    }

    private string FormatTimeSpan(TimeSpan? timeSpan)
    {
        if (!timeSpan.HasValue) return "-";
        if (timeSpan.Value.TotalSeconds == 0) return "-";
        return $"{timeSpan.Value.Hours:D2}:{timeSpan.Value.Minutes:D2}";
    }

    private string GetTatilColor(TatilTipi tatilTipi)
    {
        return tatilTipi switch
        {
            TatilTipi.SabitTatil => "#696cff",
            TatilTipi.DiniTatil => "#71dd37",
            TatilTipi.OzelTatil => "#ffab00",
            _ => "#8592a3"
        };
    }

    private string GetMesaiColor(PersonelMesaiListResponseDto mesai)
    {
        if (mesai.GecKalma) return "#ff3e1d";
        if (mesai.HaftaSonu) return "#03c3ec";
        return "#00cfe8";
    }

    private async Task SyncCalendar()
    {
        await LoadAllData();
        await RenderCalendar();
    }

    private string GetIzinMazeretColor(IzinMazeretTalepListResponseDto talep)
    {
        return talep.BirinciOnayDurumu switch
        {
            OnayDurumu.Onaylandi => "#71dd37",
            OnayDurumu.Reddedildi => "#ff3e1d",
            _ => "#ffab00"
        };
    }
}
