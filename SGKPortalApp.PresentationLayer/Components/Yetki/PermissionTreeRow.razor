@using SGKPortalApp.BusinessObjectLayer.Enums.Common
@using SGKPortalApp.PresentationLayer.Models.ViewModels

@{
    var prefix = Depth == 0 ? "" : string.Concat(Enumerable.Repeat("↳", Depth));
    var icon = Node.IslemTipi switch
    {
        YetkiIslemTipi.Grup => "bx-folder text-warning",
        YetkiIslemTipi.Page => "bx-file text-primary",
        YetkiIslemTipi.Tab => "bx-tab text-info",
        YetkiIslemTipi.Buton => "bx-pointer text-success",
        YetkiIslemTipi.Field => "bx-text text-secondary",
        YetkiIslemTipi.FormField => "bx-edit text-purple",
        _ => "bx-circle"
    };
    var tipBadge = Node.IslemTipi switch
    {
        YetkiIslemTipi.Grup => ("bg-label-warning", "Grup"),
        YetkiIslemTipi.Page => ("bg-label-primary", "Sayfa"),
        YetkiIslemTipi.Tab => ("bg-label-info", "Tab"),
        YetkiIslemTipi.Buton => ("bg-label-success", "Buton"),
        YetkiIslemTipi.Field => ("bg-label-secondary", "Field"),
        YetkiIslemTipi.FormField => ("bg-label-dark", "Input"),
        _ => ("bg-label-secondary", "?")
    };
}

<tr class="@(Node.HasChanges ? "table-warning" : "") @(Node.IsGroupNode ? "table-light" : "")">
    <td style="padding-left: @(16 + Depth * 20)px;">
        <span class="text-muted me-1">@prefix</span>
        <i class="bx @icon me-1"></i>
        <span>@Node.IslemAdi</span>
        @if (!string.IsNullOrEmpty(Node.Aciklama))
        {
            <small class="text-muted ms-1">- @Node.Aciklama</small>
        }
        @if (!string.IsNullOrEmpty(Node.PermissionKey) && !Node.IsGroupNode)
        {
            <br />
            <code class="small text-muted ms-4">@Node.PermissionKey</code>
        }
    </td>
    <td class="text-center">
        <span class="badge @tipBadge.Item1">@tipBadge.Item2</span>
    </td>
    @if (Node.IsGroupNode)
    {
        <td colspan="3" class="text-center text-muted small">—</td>
    }
    else
    {
        <td class="text-center">
            <div class="form-check d-inline-block">
                <input class="form-check-input" type="radio" 
                       name="perm_@Node.ModulControllerIslemId" 
                       checked="@(Node.SelectedLevel == YetkiSeviyesi.None)"
                       @onchange="() => OnLevelChanged.InvokeAsync((Node, YetkiSeviyesi.None))" />
            </div>
        </td>
        <td class="text-center">
            <div class="form-check d-inline-block">
                <input class="form-check-input" type="radio" 
                       name="perm_@Node.ModulControllerIslemId" 
                       checked="@(Node.SelectedLevel == YetkiSeviyesi.View)"
                       @onchange="() => OnLevelChanged.InvokeAsync((Node, YetkiSeviyesi.View))" />
            </div>
        </td>
        <td class="text-center">
            <div class="form-check d-inline-block">
                <input class="form-check-input" type="radio" 
                       name="perm_@Node.ModulControllerIslemId" 
                       checked="@(Node.SelectedLevel == YetkiSeviyesi.Edit)"
                       @onchange="() => OnLevelChanged.InvokeAsync((Node, YetkiSeviyesi.Edit))" />
            </div>
        </td>
    }
</tr>

@* Recursive render for children *@
@if (Node.Children.Any())
{
    @foreach (var child in Node.Children)
    {
        <PermissionTreeRow Node="child" Depth="Depth + 1" OnLevelChanged="OnLevelChanged" />
    }
}

@code {
    [Parameter, EditorRequired]
    public PermissionTreeNode Node { get; set; } = default!;

    [Parameter]
    public int Depth { get; set; } = 0;

    [Parameter]
    public EventCallback<(PermissionTreeNode Node, YetkiSeviyesi Level)> OnLevelChanged { get; set; }
}
