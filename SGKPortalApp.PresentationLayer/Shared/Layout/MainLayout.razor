@inherits LayoutComponentBase
@using SGKPortalApp.PresentationLayer.Components.Siramatik

<div class="layout-wrapper layout-content-navbar @(siraPanelAcik ? "sira-panel-open" : "") @(BankoModeState.IsInBankoMode ? "banko-mode-active" : "")">
    <div class="layout-container">
        <NavMenu />
        <div class="layout-page">
            <TopBar />
            <div class="content-wrapper">
                <div class="container-xxl flex-grow-1 container-p-y">
                    @Body
                </div>

                <Toast />

                <Footer />
                <div class="content-backdrop fade"></div>
            </div>
        </div>
    </div>
    <div class="layout-overlay layout-menu-toggle"></div>
</div>

@* SÄ±ra Ã‡aÄŸÄ±rma Paneli - Sadece Banko Modunda GÃ¶rÃ¼nÃ¼r *@
@if (BankoModeState.IsInBankoMode)
{
    <SiraCagirmaPanel SiraListesi="@siraListesi" OnSiraCagir="@HandleSiraCagir" OnPanelStateChanged="@HandlePanelStateChanged" />
}

@* SignalR BaÄŸlantÄ±sÄ± - Authenticated kullanÄ±cÄ±lar iÃ§in HubConnection oluÅŸturur *@
@* NOT: TV Display sayfasÄ± kendi SignalR'Ä±nÄ± yÃ¶netir, bu sadece MainLayout iÃ§in *@
<script src="/lib/microsoft/signalr/dist/browser/signalr.js"></script>
<script src="/js/signalr-connection-manager.js"></script>
<script src="/js/banko-mode.js"></script>
<script>
    (function() {
        // MainLayout iÃ§in merkezi SignalR yÃ¶neticisini baÅŸlat
        const manager = initializeSignalR('/hubs/siramatik');
        manager.initialize();

        let forceLogoutBound = false;

        function attachForceLogoutHandler(connection) {
            if (!connection || forceLogoutBound) {
                return;
            }

            forceLogoutBound = true;

            connection.on("ForceLogout", (message) => {
                console.warn("âš ï¸ ForceLogout alÄ±ndÄ±:", message);

                // KullanÄ±cÄ±ya bilgi ver
                alert(message);

                // LocalStorage temizle (tab kimliÄŸini korumak iÃ§in sessionStorage'Ä± silme)
                localStorage.clear();

                // Cookie'leri temizle
                document.cookie.split(";").forEach((c) => {
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                });

                // Login sayfasÄ±na yÃ¶nlendir
                window.location.href = "/Account/Login";
            });
        }

        manager.addEventListener('connected', () => {
            console.log('âœ… MainLayout - SignalR baÄŸlantÄ±sÄ± kuruldu');
            const connection = manager.connection;
            window.bankoMode.setConnection(connection);
            attachForceLogoutHandler(connection);
        });

        manager.addEventListener('reconnected', () => {
            console.log('âœ… MainLayout - SignalR yeniden baÄŸlandÄ±');
            const connection = manager.connection;
            window.bankoMode.setConnection(connection);
            attachForceLogoutHandler(connection);
        });

        manager.addEventListener('statusChecked', (state) => {
            if (state === 'Disconnected') {
                console.log('ğŸ”´ MainLayout - SignalR baÄŸlantÄ±sÄ± koptu');
            }
        });

    })();
</script>
