@page "/yetki/yetki-islem"
@inherits SGKPortalApp.PresentationLayer.Components.Base.FieldPermissionPageBase
@using SGKPortalApp.BusinessObjectLayer.DTOs.Response.Common
@using SGKPortalApp.BusinessObjectLayer.DTOs.Request.Common
@using SGKPortalApp.BusinessObjectLayer.DTOs.Common
@using SGKPortalApp.BusinessObjectLayer.Enums.Common

<PageTitle>ƒ∞≈ülem Y√∂netimi - SGK Portal</PageTitle>

<div class="container-xxl flex-grow-1 container-p-y">
    @if (!CanViewPage)
    {
        <div class="alert alert-danger" role="alert">
            <i class="bx bx-lock-alt me-2"></i>
            Bu sayfayƒ± g√∂r√ºnt√ºleme yetkiniz bulunmuyor.
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-1">
                    <i class="bx bx-list-ul me-2"></i>ƒ∞≈ülem Y√∂netimi
                </h4>
                <p class="text-muted mb-0">Controller i≈ülemlerini y√∂netin (Action'lar)</p>
            </div>
            <button class="btn btn-primary" @onclick="ShowAddModal">
                <i class="bx bx-plus me-1"></i>Yeni ƒ∞≈ülem
            </button>
        </div>

        <!-- Search Card -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Arama</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bx bx-search"></i>
                            </span>
                            <input type="text"
                                   class="form-control"
                                   placeholder="ƒ∞≈ülem adƒ± ile ara..."
                                   @bind="SearchTerm"
                                   @bind:event="oninput"
                                   @onkeyup="ApplyFilter" />
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Mod√ºl Filtresi</label>
                        <select class="form-select" @bind="FilterModulId" @bind:after="ApplyFilter">
                            <option value="0">T√ºm√º</option>
                            @foreach (var m in Moduller)
                            {
                                <option value="@m.ModulId">@m.ModulAdi</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Controller Filtresi</label>
                        <select class="form-select" @bind="FilterControllerId" @bind:after="ApplyFilter">
                            <option value="0">T√ºm√º</option>
                            @foreach (var c in AllControllers)
                            {
                                <option value="@c.Id">@c.Ad</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ƒ∞≈ülem Tipi</label>
                        <select class="form-select" @bind="FilterIslemTipi" @bind:after="ApplyFilter">
                            <option value="-1">T√ºm√º</option>
                            <option value="@((int)YetkiIslemTipi.Page)">Sayfa</option>
                            <option value="@((int)YetkiIslemTipi.Tab)">Tab</option>
                            <option value="@((int)YetkiIslemTipi.Buton)">Buton</option>
                            <option value="@((int)YetkiIslemTipi.Field)">Field</option>
                            <option value="@((int)YetkiIslemTipi.FormField)">FormField</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bx bx-list-ul me-2"></i>Yetki ƒ∞≈ülemleri
                        </h5>
                        <small class="text-muted">Mod√ºl & controller i≈ülemlerini hiyerar≈üik olarak g√∂r√ºnt√ºleyin</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="ApplyFilter">
                            <i class="bx bx-refresh"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                @if (IsLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2 text-muted">Y√ºkleniyor...</p>
                    </div>
                }
                else if (!Islemler.Any())
                {
                    <div class="text-center py-5">
                        <i class="bx bx-list-ul" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="mt-2 text-muted">Hen√ºz i≈ülem eklenmemi≈ü</p>
                    </div>
                }
                else
                {
                    <div class="accordion accordion-flush" id="moduleAccordion">
                        @{
                            var moduleIndex = 0;
                        }
                        @foreach (var moduleGroup in FilteredIslemlerDisplay
                            .GroupBy(i => new { i.ModulId, i.ModulAdi })
                            .OrderBy(g => g.Key.ModulAdi))
                        {
                            var collapseId = $"moduleCollapse_{moduleIndex}";
                            var headingId = $"moduleHeading_{moduleIndex}";
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="@headingId">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false" aria-controls="@collapseId">
                                        <i class="bx bx-grid-alt me-2 text-primary"></i>
                                        <strong>@moduleGroup.Key.ModulAdi</strong>
                                        <span class="badge bg-label-primary ms-2">@moduleGroup.Count()</span>
                                    </button>
                                </h2>
                                <div id="@collapseId" class="accordion-collapse collapse" aria-labelledby="@headingId" data-bs-parent="#moduleAccordion">
                                    <div class="accordion-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover mb-0">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th style="width: 25%;">ƒ∞≈ülem Adƒ±</th>
                                                        <th style="width: 12%;">ƒ∞≈ülem Tipi</th>
                                                        <th style="width: 15%;">Route</th>
                                                        <th style="width: 18%;">Permission Key</th>
                                                        @* <th style="width: 12%;">Sayfa Tipi</th> *@
                                                        <th style="width: 10%;">Min. Yetki</th>
                                                        <th class="text-end" style="width: 8%;">ƒ∞≈ülemler</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var controllerGroup in moduleGroup
                                                        .GroupBy(i => new { i.ModulControllerId, i.ModulControllerAdi })
                                                        .OrderBy(g => g.Key.ModulControllerAdi))
                                                    {
                                                        <tr class="table-secondary">
                                                            <td colspan="7">
                                                                <i class="bx bx-folder me-2 text-muted"></i>
                                                                <strong>@controllerGroup.Key.ModulControllerAdi</strong>
                                                                <span class="badge bg-label-secondary ms-2">@controllerGroup.Count()</span>
                                                            </td>
                                                        </tr>

                                                        @foreach (var islem in controllerGroup
                                                            .OrderBy(i => i.UstIslemId.HasValue)
                                                            .ThenBy(i => i.ModulControllerIslemAdi))
                                                        {
                                                            var isChild = islem.UstIslemId.HasValue;
                                                            <tr>
                                                                <td>
                                                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                                                        @if (isChild)
                                                                        {
                                                                            <span class="text-muted">‚îî</span>
                                                                        }
                                                                        <strong>@islem.ModulControllerIslemAdi</strong>
                                                                        @if (!string.IsNullOrEmpty(islem.UstIslemAdi))
                                                                        {
                                                                            <span class="badge bg-label-light text-muted">√úst: @islem.UstIslemAdi</span>
                                                                        }
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    @switch (islem.IslemTipi)
                                                                    {
                                                                        case YetkiIslemTipi.Page:
                                                                            <span class="badge bg-label-primary">üìÑ Sayfa</span>
                                                                            break;
                                                                        case YetkiIslemTipi.Tab:
                                                                            <span class="badge bg-label-info">üìë Tab</span>
                                                                            break;
                                                                        case YetkiIslemTipi.Buton:
                                                                            <span class="badge bg-label-warning">üîò Buton</span>
                                                                            break;
                                                                        case YetkiIslemTipi.Field:
                                                                            <span class="badge bg-label-success">üìù Field</span>
                                                                            break;
                                                                        case YetkiIslemTipi.FormField:
                                                                            <span class="badge bg-label-secondary">‚úèÔ∏è FormField</span>
                                                                            break;
                                                                    }
                                                                </td>
                                                                <td>
                                                                    <small><code class="text-primary">@((islem.Route ?? "-"))</code></small>
                                                                </td>
                                                                <td>
                                                                    <small><code class="text-secondary">@((islem.PermissionKey ?? "-"))</code></small>
                                                                </td>
                                                                @* <td>
                                                                    @switch (islem.SayfaTipi)
                                                                    {
                                                                        case SayfaTipi.Public:
                                                                            <span class="badge bg-success">Public</span>
                                                                            break;
                                                                        case SayfaTipi.Authenticated:
                                                                            <span class="badge bg-info">Authenticated</span>
                                                                            break;
                                                                        case SayfaTipi.Protected:
                                                                            <span class="badge bg-warning">Protected</span>
                                                                            break;
                                                                    }
                                                                </td> *@
                                                                <td>
                                                                    @switch (islem.MinYetkiSeviyesi)
                                                                    {
                                                                        case YetkiSeviyesi.None:
                                                                            <span class="badge bg-label-secondary">None</span>
                                                                            break;
                                                                        case YetkiSeviyesi.View:
                                                                            <span class="badge bg-label-info">View</span>
                                                                            break;
                                                                        case YetkiSeviyesi.Edit:
                                                                            <span class="badge bg-label-primary">Edit</span>
                                                                            break;
                                                                    }
                                                                </td>
                                                                <td class="text-end">
                                                                    <button class="btn btn-sm btn-icon btn-outline-primary me-1" @onclick="() => StartEdit(islem)">
                                                                        <i class="bx bx-edit"></i>
                                                                    </button>
                                                                    <button class="btn btn-sm btn-icon btn-outline-danger" @onclick="() => DeleteIslem(islem)">
                                                                        <i class="bx bx-trash"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            moduleIndex++;
                        }
                    </div>

                    <div class="p-3 border-top bg-light">
                        <span class="text-muted small">
                            <i class="bx bx-list-ul text-primary"></i>
                            @if (FilteredIslemlerDisplay.Count != Islemler.Count)
                            {
                                <text>G√∂sterilen: <strong>@FilteredIslemlerDisplay.Count</strong> / Toplam: <strong>@Islemler.Count</strong> i≈ülem</text>
                            }
                            else
                            {
                                <text>Toplam: <strong>@Islemler.Count</strong> i≈ülem</text>
                            }
                        </span>
                    </div>
                }
            </div>
        </div>
    }
</div>

@if (ShowModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(EditingId.HasValue ? "ƒ∞≈ülem D√ºzenle" : "Yeni ƒ∞≈ülem")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mod√ºl <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="SelectedModulId" @bind:after="OnModulChanged">
                                <option value="0">-- Mod√ºl Se√ßiniz --</option>
                                @foreach (var m in Moduller)
                                {
                                    <option value="@m.ModulId">@m.ModulAdi (@m.ModulKodu)</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Controller <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="SelectedControllerId" @bind:after="OnControllerChanged" disabled="@(SelectedModulId <= 0)">
                                <option value="0">-- Controller Se√ßiniz --</option>
                                @foreach (var c in FilteredControllers)
                                {
                                    <option value="@c.Id" title="@c.Metadata">@c.Ad</option>
                                }
                            </select>
                            @if (SelectedControllerId > 0)
                            {
                                var selectedController = FilteredControllers.FirstOrDefault(c => c.Id == SelectedControllerId);
                                if (selectedController?.Metadata != null)
                                {
                                    <small class="text-muted">
                                        <i class="bx bx-folder-tree"></i> Hiyerar≈üik yol: <strong>@selectedController.Metadata</strong>
                                    </small>
                                }
                            }
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ƒ∞≈ülem Tipi</label>
                            <select class="form-select" @bind="SelectedIslemTipi" @bind:after="OnIslemTipiChanged">
                                <option value="@YetkiIslemTipi.Page">üìÑ Sayfa</option>
                                <option value="@YetkiIslemTipi.Tab">üìë Tab</option>
                                <option value="@YetkiIslemTipi.Buton">üîò Buton</option>
                                <option value="@YetkiIslemTipi.Field">üìù Field (G√∂r√ºnt√ºleme)</option>
                                <option value="@YetkiIslemTipi.FormField">‚úèÔ∏è Input (Form Alanƒ±)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            @if (IsButonType)
                            {
                                <label class="form-label">ƒ∞≈ülem Adƒ± (ActionType) <span class="text-danger">*</span></label>
                                <select class="form-select" @bind="SelectedActionType" @bind:after="OnActionTypeChanged" disabled="@IsLoadingActionTypes">
                                    <option value="">-- Action Se√ßiniz --</option>
                                    @if (IsLoadingActionTypes)
                                    {
                                        <option value="">‚è≥ Y√ºkleniyor...</option>
                                    }
                                    else
                                    {
                                        @foreach (var action in ActionTypes)
                                        {
                                            <option value="@action.Ad">@action.Aciklama (@action.Ad)</option>
                                        }
                                    }
                                </select>
                                <small class="text-muted">
                                    @if (IsLoadingActionTypes)
                                    {
                                        <i class="bx bx-loader-alt bx-spin"></i> <text>ActionType listesi y√ºkleniyor...</text>
                                    }
                                    else if (!string.IsNullOrEmpty(SelectedActionType))
                                    {
                                        <i class="bx bx-check-circle text-success"></i> <text>Se√ßilen: @SelectedActionType</text>
                                    }
                                    else
                                    {
                                        <i class="bx bx-info-circle"></i> <text>Standart action tipi se√ßiniz</text>
                                    }
                                </small>
                            }
                            else
                            {
                                <label class="form-label">ƒ∞≈ülem Adƒ± <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" @bind="IslemAdi" @bind:after="OnIslemAdiChanged" placeholder="√ñrn: LIST, CREATE, DELETE..." />
                                <small class="text-muted">Field tipi se√ßiliyse DTO Field Name'den otomatik doldurulur</small>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            √úst ƒ∞≈ülem (Sayfa)
                            @if (SelectedIslemTipi != YetkiIslemTipi.Page)
                            {
                                <span class="text-danger">*</span>
                            }
                        </label>
                        <select class="form-select" @bind="SelectedUstIslemId" @bind:after="OnUstIslemChanged" disabled="@(SelectedControllerId <= 0)">
                            <option value="0">-- @(SelectedIslemTipi == YetkiIslemTipi.Page ? "√úst ƒ∞≈ülem Yok (K√∂k Seviye)" : "Sayfa Se√ßiniz") --</option>
                            @foreach (var i in FilteredIslemler)
                            {
                                <option value="@i.ModulControllerIslemId">@GetIslemPrefix(i) @i.ModulControllerIslemAdi</option>
                            }
                        </select>
                        <small class="text-muted">
                            @if (SelectedIslemTipi == YetkiIslemTipi.Page)
                            {
                                <text>Sayfalar k√∂k seviyede olabilir veya ba≈üka bir sayfanƒ±n altƒ±nda</text>
                            }
                            else
                            {
                                <text>Tab, Buton, Field ve FormField mutlaka bir sayfa altƒ±nda olmalƒ±dƒ±r (Sadece Page tipindeki i≈ülemler g√∂sterilir)</text>
                            }
                        </small>
                    </div>

                    @* DTO Mapping - Sadece Field/FormField i√ßin g√∂ster *@
                    @if (IsFieldType)
                    {
                        <hr class="my-3" />
                        <h6 class="mb-3"><i class="bx bx-code me-1"></i>DTO/Backend Mapping</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">DTO Type Name</label>
                                <select class="form-select" @bind="DtoTypeName" @bind:after="OnDtoTypeChanged" disabled="@IsLoadingDtoTypes">
                                    <option value="">-- DTO Se√ßiniz --</option>
                                    @if (IsLoadingDtoTypes)
                                    {
                                        <option value="">‚è≥ Y√ºkleniyor...</option>
                                    }
                                    else
                                    {
                                        @foreach (var group in DtoTypes.GroupBy(d => d.Category))
                                        {
                                            <optgroup label="@group.Key">
                                                @foreach (var dto in group)
                                                {
                                                    <option value="@dto.TypeName">@dto.DisplayName</option>
                                                }
                                            </optgroup>
                                        }
                                    }
                                </select>
                                <small class="text-muted">
                                    @if (IsLoadingDtoTypes)
                                    {
                                        <i class="bx bx-loader-alt bx-spin"></i> <text>DTO'lar y√ºkleniyor...</text>
                                    }
                                    else if (!string.IsNullOrEmpty(DtoTypeName))
                                    {
                                        <i class="bx bx-check-circle text-success"></i> <text>Se√ßilen: @DtoTypeName</text>
                                    }
                                    else
                                    {
                                        <i class="bx bx-info-circle"></i> <text>Backend DTO sƒ±nƒ±fƒ±</text>
                                    }
                                </small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">DTO Field Name <span class="text-danger">*</span></label>
                                <select class="form-select" @bind="DtoFieldName" @bind:after="OnDtoFieldNameChanged"
                                        disabled="@(string.IsNullOrEmpty(DtoTypeName) || IsLoadingDtoFields)">
                                    <option value="">-- Field Se√ßiniz --</option>
                                    @if (IsLoadingDtoFields)
                                    {
                                        <option value="">‚è≥ Y√ºkleniyor...</option>
                                    }
                                    else
                                    {
                                        @foreach (var field in DtoFields)
                                        {
                                            <option value="@field.PropertyName">
                                                @field.DisplayName (@field.PropertyType)@(field.IsRequired ? " *" : "")
                                            </option>
                                        }
                                    }
                                </select>
                                <small class="text-muted">
                                    @if (string.IsNullOrEmpty(DtoTypeName))
                                    {
                                        <i class="bx bx-info-circle"></i> <text>√ñnce DTO Type se√ßiniz</text>
                                    }
                                    else if (IsLoadingDtoFields)
                                    {
                                        <i class="bx bx-loader-alt bx-spin"></i> <text>Field'lar y√ºkleniyor...</text>
                                    }
                                    else if (!DtoFields.Any())
                                    {
                                        <i class="bx bx-error text-warning"></i> <text>Field bulunamadƒ±</text>
                                    }
                                    else if (!string.IsNullOrEmpty(DtoFieldName))
                                    {
                                        <i class="bx bx-check-circle text-success"></i> <text>Se√ßilen: @DtoFieldName (ƒ∞≈ülem Adƒ± otomatik doldurulacak)</text>
                                    }
                                    else
                                    {
                                        <i class="bx bx-info-circle"></i> <text>@DtoFields.Count field mevcut</text>
                                    }
                                </small>
                            </div>
                        </div>
                    }

                    @* Route - Sadece Page i√ßin g√∂ster *@
                    @if (ShowRouteField)
                    {
                        <hr class="my-3" />
                        <h6 class="mb-3"><i class="bx bx-map me-1"></i>Sayfa Bilgileri</h6>
                        <div class="mb-3">
                            <label class="form-label">Route (Sayfa Yolu)</label>
                            <input type="text" class="form-control" @bind="Route" @bind:after="OnRouteChanged" placeholder="√ñrn: /siramatik/banko/list" />
                            <small class="text-muted">
                                Controller hiyerar≈üisine uygun route girin. Sayfa adƒ± otomatik ƒ∞≈ülem Adƒ±'na yazƒ±lacak.<br/>
                                <strong>Beklenen format:</strong> /@(FilteredControllers.FirstOrDefault(c => c.Id == SelectedControllerId)?.Ad?.Replace(" > ", "/").ToLower() ?? "controller")/[sayfa-adi]
                            </small>
                        </div>
                    }

                    <hr class="my-3" />
                    <h6 class="mb-3"><i class="bx bx-shield me-1"></i>Yetki Ayarlarƒ±</h6>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Permission Key <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" @bind="PermissionKey" placeholder="Otomatik olu≈üturulacak" readonly style="background-color: #f0f0f0;" />
                            <small class="text-muted">Otomatik olu≈üturulur: ModulKodu.ControllerAdi.√ústIslem.IslemAdi</small>
                        </div>
                    </div>
                    <div class="row">
                        @* <div class="col-md-6 mb-3">
                            <label class="form-label">Sayfa Tipi</label>
                            <select class="form-select" @bind="SelectedSayfaTipi">
                                <option value="@SayfaTipi.Public">Public (Herkes eri≈üebilir)</option>
                                <option value="@SayfaTipi.Authenticated">Authenticated (Login yeterli)</option>
                                <option value="@SayfaTipi.Protected">Protected (Yetki gerekli)</option>
                            </select>
                        </div> *@
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Minimum Yetki Seviyesi</label>
                            <select class="form-select" @bind="SelectedMinYetki" disabled="@(SelectedSayfaTipi != SayfaTipi.Protected)">
                                <option value="@YetkiSeviyesi.None">None (Eri≈üim Yok)</option>
                                <option value="@YetkiSeviyesi.View">View (G√∂r√ºnt√ºleme)</option>
                                <option value="@YetkiSeviyesi.Edit">Edit (D√ºzenleme)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">ƒ∞ptal</button>
                    <button class="btn btn-primary" @onclick="SaveIslem" disabled="@IsSaving">
                        @if (IsSaving) { <span class="spinner-border spinner-border-sm me-1"></span> }
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
}
