@page "/yetki/islem"
@using SGKPortalApp.BusinessObjectLayer.DTOs.Response.Common
@using SGKPortalApp.BusinessObjectLayer.DTOs.Request.Common
@using SGKPortalApp.BusinessObjectLayer.Enums.Common
@using SGKPortalApp.PresentationLayer.Services.UIServices.Interfaces
@using SGKPortalApp.PresentationLayer.Services.ApiServices.Interfaces.Common
@inject IModulControllerIslemApiService IslemApiService
@inject IModulControllerApiService ControllerApiService
@inject IModulApiService ModulApiService
@inject IDtoDiscoveryApiService DtoDiscoveryApiService
@inject IJSRuntime JS
@inject IToastService ToastService

<PageTitle>ƒ∞≈ülem Y√∂netimi - SGK Portal</PageTitle>

<div class="container-xxl flex-grow-1 container-p-y">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">
                <i class="bx bx-list-ul me-2"></i>ƒ∞≈ülem Y√∂netimi
            </h4>
            <p class="text-muted mb-0">Controller i≈ülemlerini y√∂netin (Action'lar)</p>
        </div>
        <button class="btn btn-primary" @onclick="ShowAddModal">
            <i class="bx bx-plus me-1"></i>Yeni ƒ∞≈ülem
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            @if (IsLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 text-muted">Y√ºkleniyor...</p>
                </div>
            }
            else if (!Islemler.Any())
            {
                <div class="text-center py-5">
                    <i class="bx bx-list-ul" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="mt-2 text-muted">Hen√ºz i≈ülem eklenmemi≈ü</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ƒ∞≈ülem Adƒ±</th>
                                <th>Route</th>
                                <th>Permission Key</th>
                                <th>Sayfa Tipi</th>
                                <th>Min. Yetki</th>
                                <th>Controller / Mod√ºl</th>
                                <th class="text-end">ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var i in Islemler)
                            {
                                <tr>
                                    <td>@i.ModulControllerIslemId</td>
                                    <td><strong>@i.ModulControllerIslemAdi</strong></td>
                                    <td><code class="text-primary">@(i.Route ?? "-")</code></td>
                                    <td><code class="text-secondary">@(i.PermissionKey ?? "-")</code></td>
                                    <td>
                                        @switch (i.SayfaTipi)
                                        {
                                            case SayfaTipi.Public:
                                                <span class="badge bg-success">Public</span>
                                                break;
                                            case SayfaTipi.Authenticated:
                                                <span class="badge bg-info">Authenticated</span>
                                                break;
                                            case SayfaTipi.Protected:
                                                <span class="badge bg-warning">Protected</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        @switch (i.MinYetkiSeviyesi)
                                        {
                                            case YetkiSeviyesi.None:
                                                <span class="badge bg-label-secondary">None</span>
                                                break;
                                            case YetkiSeviyesi.View:
                                                <span class="badge bg-label-info">View</span>
                                                break;
                                            case YetkiSeviyesi.Edit:
                                                <span class="badge bg-label-primary">Edit</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-label-info">@i.ModulControllerAdi</span>
                                        <span class="badge bg-label-primary">@i.ModulAdi</span>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-icon btn-outline-primary me-1" @onclick="() => StartEdit(i)">
                                            <i class="bx bx-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-icon btn-outline-danger" @onclick="() => DeleteIslem(i)">
                                            <i class="bx bx-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@if (ShowModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(EditingId.HasValue ? "ƒ∞≈ülem D√ºzenle" : "Yeni ƒ∞≈ülem")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mod√ºl <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="SelectedModulId" @bind:after="OnModulChanged">
                                <option value="0">-- Mod√ºl Se√ßiniz --</option>
                                @foreach (var m in Moduller)
                                {
                                    <option value="@m.ModulId">@m.ModulAdi (@m.ModulKodu)</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Controller <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="SelectedControllerId" @bind:after="OnControllerChanged" disabled="@(SelectedModulId <= 0)">
                                <option value="0">-- Controller Se√ßiniz --</option>
                                @foreach (var c in FilteredControllers)
                                {
                                    <option value="@c.Id">@c.Ad</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ƒ∞≈ülem Adƒ± <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" @bind="IslemAdi" @bind:after="OnIslemAdiChanged" placeholder="√ñrn: LIST, CREATE, DELETE..." />
                            <small class="text-muted">Field tipi se√ßiliyse DTO Field Name'den otomatik doldurulur</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ƒ∞≈ülem Tipi</label>
                            <select class="form-select" @bind="SelectedIslemTipi" @bind:after="OnIslemTipiChanged">
                                <option value="@YetkiIslemTipi.Page">üìÑ Sayfa</option>
                                <option value="@YetkiIslemTipi.Tab">üìë Tab</option>
                                <option value="@YetkiIslemTipi.Buton">üîò Buton</option>
                                <option value="@YetkiIslemTipi.Field">üìù Field (G√∂r√ºnt√ºleme)</option>
                                <option value="@YetkiIslemTipi.FormField">‚úèÔ∏è Input (Form Alanƒ±)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">√úst ƒ∞≈ülem (Opsiyonel)</label>
                        <select class="form-select" @bind="SelectedUstIslemId" @bind:after="OnUstIslemChanged" disabled="@(SelectedControllerId <= 0)">
                            <option value="0">-- √úst ƒ∞≈ülem Yok (K√∂k Seviye) --</option>
                            @foreach (var i in FilteredIslemler)
                            {
                                <option value="@i.ModulControllerIslemId">@GetIslemPrefix(i) @i.ModulControllerIslemAdi</option>
                            }
                        </select>
                        <small class="text-muted">Bu i≈ülem ba≈üka bir i≈ülemin altƒ±nda mƒ±? (√ñrn: Buton ‚Üí Sayfa altƒ±nda)</small>
                    </div>

                    @* DTO Mapping - Sadece Field/FormField i√ßin g√∂ster *@
                    @if (IsFieldType)
                    {
                        <hr class="my-3" />
                        <h6 class="mb-3"><i class="bx bx-code me-1"></i>DTO/Backend Mapping</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">DTO Type Name</label>
                                <select class="form-select" @bind="DtoTypeName" @bind:after="OnDtoTypeChanged" disabled="@IsLoadingDtoTypes">
                                    <option value="">-- DTO Se√ßiniz --</option>
                                    @if (IsLoadingDtoTypes)
                                    {
                                        <option value="">‚è≥ Y√ºkleniyor...</option>
                                    }
                                    else
                                    {
                                        @foreach (var group in DtoTypes.GroupBy(d => d.Category))
                                        {
                                            <optgroup label="@group.Key">
                                                @foreach (var dto in group)
                                                {
                                                    <option value="@dto.TypeName">@dto.DisplayName</option>
                                                }
                                            </optgroup>
                                        }
                                    }
                                </select>
                                <small class="text-muted">
                                    @if (IsLoadingDtoTypes)
                                    {
                                        <i class="bx bx-loader-alt bx-spin"></i> <text>DTO'lar y√ºkleniyor...</text>
                                    }
                                    else if (!string.IsNullOrEmpty(DtoTypeName))
                                    {
                                        <i class="bx bx-check-circle text-success"></i> <text>Se√ßilen: @DtoTypeName</text>
                                    }
                                    else
                                    {
                                        <i class="bx bx-info-circle"></i> <text>Backend DTO sƒ±nƒ±fƒ±</text>
                                    }
                                </small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">DTO Field Name <span class="text-danger">*</span></label>
                                <select class="form-select" @bind="DtoFieldName" @bind:after="OnDtoFieldNameChanged"
                                        disabled="@(string.IsNullOrEmpty(DtoTypeName) || IsLoadingDtoFields)">
                                    <option value="">-- Field Se√ßiniz --</option>
                                    @if (IsLoadingDtoFields)
                                    {
                                        <option value="">‚è≥ Y√ºkleniyor...</option>
                                    }
                                    else
                                    {
                                        @foreach (var field in DtoFields)
                                        {
                                            <option value="@field.PropertyName">
                                                @field.DisplayName (@field.PropertyType)@(field.IsRequired ? " *" : "")
                                            </option>
                                        }
                                    }
                                </select>
                                <small class="text-muted">
                                    @if (string.IsNullOrEmpty(DtoTypeName))
                                    {
                                        <i class="bx bx-info-circle"></i> <text>√ñnce DTO Type se√ßiniz</text>
                                    }
                                    else if (IsLoadingDtoFields)
                                    {
                                        <i class="bx bx-loader-alt bx-spin"></i> <text>Field'lar y√ºkleniyor...</text>
                                    }
                                    else if (!DtoFields.Any())
                                    {
                                        <i class="bx bx-error text-warning"></i> <text>Field bulunamadƒ±</text>
                                    }
                                    else if (!string.IsNullOrEmpty(DtoFieldName))
                                    {
                                        <i class="bx bx-check-circle text-success"></i> <text>Se√ßilen: @DtoFieldName (ƒ∞≈ülem Adƒ± otomatik doldurulacak)</text>
                                    }
                                    else
                                    {
                                        <i class="bx bx-info-circle"></i> <text>@DtoFields.Count field mevcut</text>
                                    }
                                </small>
                            </div>
                        </div>
                    }

                    @* Route - Sadece Page i√ßin g√∂ster *@
                    @if (ShowRouteField)
                    {
                        <hr class="my-3" />
                        <h6 class="mb-3"><i class="bx bx-map me-1"></i>Sayfa Bilgileri</h6>
                        <div class="mb-3">
                            <label class="form-label">Route (Sayfa Yolu)</label>
                            <input type="text" class="form-control" @bind="Route" placeholder="√ñrn: /personel/manage, /siramatik/banko/list" />
                            <small class="text-muted">Bu sayfanƒ±n URL yolu</small>
                        </div>
                    }

                    <hr class="my-3" />
                    <h6 class="mb-3"><i class="bx bx-shield me-1"></i>Yetki Ayarlarƒ±</h6>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Permission Key <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" @bind="PermissionKey" placeholder="Otomatik olu≈üturulacak" readonly style="background-color: #f0f0f0;" />
                            <small class="text-muted">Otomatik olu≈üturulur: ModulKodu.ControllerAdi.√ústIslem.IslemAdi</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sayfa Tipi</label>
                            <select class="form-select" @bind="SelectedSayfaTipi">
                                <option value="@SayfaTipi.Public">Public (Herkes eri≈üebilir)</option>
                                <option value="@SayfaTipi.Authenticated">Authenticated (Login yeterli)</option>
                                <option value="@SayfaTipi.Protected">Protected (Yetki gerekli)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Minimum Yetki Seviyesi</label>
                            <select class="form-select" @bind="SelectedMinYetki" disabled="@(SelectedSayfaTipi != SayfaTipi.Protected)">
                                <option value="@YetkiSeviyesi.None">None (Eri≈üim Yok)</option>
                                <option value="@YetkiSeviyesi.View">View (G√∂r√ºnt√ºleme)</option>
                                <option value="@YetkiSeviyesi.Edit">Edit (D√ºzenleme)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">ƒ∞ptal</button>
                    <button class="btn btn-primary" @onclick="SaveIslem" disabled="@IsSaving">
                        @if (IsSaving) { <span class="spinner-border spinner-border-sm me-1"></span> }
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<ModulControllerIslemResponseDto> Islemler = new();
    private List<ModulControllerIslemResponseDto> FilteredIslemler = new();
    private List<ModulResponseDto> Moduller = new(); // ‚Üê ModulKodu i√ßin ModulResponseDto kullan
    private List<DropdownItemDto> FilteredControllers = new();
    private bool IsLoading = true;
    private bool IsSaving = false;
    private bool ShowModal = false;
    private int? EditingId = null;
    private int SelectedModulId = 0;
    private int SelectedControllerId = 0;
    private string IslemAdi = string.Empty;
    private string? Route = null;
    private string? PermissionKey = null;
    private SayfaTipi SelectedSayfaTipi = SayfaTipi.Protected;
    private YetkiSeviyesi SelectedMinYetki = YetkiSeviyesi.View;
    private YetkiIslemTipi SelectedIslemTipi = YetkiIslemTipi.Page;
    private int SelectedUstIslemId = 0;
    private string? DtoTypeName = null;
    private string? DtoFieldName = null;

    // DTO Discovery states
    private List<DtoTypeInfo> DtoTypes = new();
    private List<DtoPropertyInfo> DtoFields = new();
    private bool IsLoadingDtoTypes = false;
    private bool IsLoadingDtoFields = false;

    // Computed properties for conditional rendering
    private bool IsFieldType => SelectedIslemTipi == YetkiIslemTipi.Field || SelectedIslemTipi == YetkiIslemTipi.FormField;
    private bool ShowRouteField => SelectedIslemTipi == YetkiIslemTipi.Page;

    protected override async Task OnInitializedAsync()
    {
        await LoadModulDropdown();
        await LoadDtoTypes();
        await LoadData();
    }

    private async Task LoadModulDropdown()
    {
        var result = await ModulApiService.GetAllAsync(); // ‚Üê ModulKodu'ya eri≈üim i√ßin GetAllAsync kullan
        if (result.Success && result.Data != null)
            Moduller = result.Data;
    }

    private async Task OnModulChanged()
    {
        SelectedControllerId = 0;
        SelectedUstIslemId = 0;
        FilteredControllers = new();
        FilteredIslemler = new();

        if (SelectedModulId > 0)
        {
            var result = await ControllerApiService.GetDropdownByModulIdAsync(SelectedModulId);
            if (result.Success && result.Data != null)
                FilteredControllers = result.Data;
        }
    }

    private void OnControllerChanged()
    {
        SelectedUstIslemId = 0;
        FilteredIslemler = Islemler
            .Where(i => i.ModulControllerId == SelectedControllerId && i.ModulControllerIslemId != EditingId)
            .OrderBy(i => i.ModulControllerIslemAdi)
            .ToList();

        GeneratePermissionKey();
    }

    private async Task OnDtoTypeChanged()
    {
        // DTO Type deƒüi≈ütiƒüinde field'larƒ± temizle ve yeni DTO'nun field'larƒ±nƒ± y√ºkle
        DtoFieldName = null;
        DtoFields = new();

        if (!string.IsNullOrEmpty(DtoTypeName))
        {
            await LoadDtoFields(DtoTypeName);
        }

        GeneratePermissionKey();
    }

    private void OnDtoFieldNameChanged()
    {
        // DTO Field Name se√ßildiƒüinde ƒ∞≈ülem Adƒ±'nƒ± otomatik doldur (uppercase)
        if (!string.IsNullOrWhiteSpace(DtoFieldName) && string.IsNullOrWhiteSpace(IslemAdi))
        {
            IslemAdi = DtoFieldName.ToUpperInvariant();
        }
        GeneratePermissionKey();
    }

    private void OnIslemAdiChanged()
    {
        GeneratePermissionKey();
    }

    private void OnUstIslemChanged()
    {
        GeneratePermissionKey();
    }

    private void OnIslemTipiChanged()
    {
        // ƒ∞≈ülem tipi deƒüi≈ütiƒüinde ilgili alanlarƒ± temizle
        if (!IsFieldType)
        {
            DtoTypeName = null;
            DtoFieldName = null;
        }

        if (!ShowRouteField)
        {
            Route = null;
        }

        GeneratePermissionKey();
    }

    private void GeneratePermissionKey()
    {
        // Permission Key'i otomatik olu≈ütur
        if (SelectedModulId == 0 || SelectedControllerId == 0 || string.IsNullOrWhiteSpace(IslemAdi))
        {
            PermissionKey = null;
            return;
        }

        var modul = Moduller.FirstOrDefault(m => m.ModulId == SelectedModulId);
        var controller = FilteredControllers.FirstOrDefault(c => c.Id == SelectedControllerId);

        if (modul == null || controller == null)
        {
            PermissionKey = null;
            return;
        }

        // ModulKodu (√∂rn: PER) - Artƒ±k doƒürudan ModulKodu'dan alƒ±nƒ±yor
        var modulKodu = modul.ModulKodu?.ToUpperInvariant() ?? "UNKNOWN";

        // Controller adƒ± (√∂rn: PERSONEL)
        var controllerAdi = controller.Ad?.ToUpperInvariant() ?? "UNKNOWN";

        // ƒ∞≈ülem adƒ± (zaten uppercase)
        var islemAdi = IslemAdi.Trim().ToUpperInvariant();

        // ƒ∞≈ülem tipine g√∂re prefix belirle
        string tipPrefix = SelectedIslemTipi switch
        {
            YetkiIslemTipi.Field => "FIELD",
            YetkiIslemTipi.FormField => "FIELD",
            YetkiIslemTipi.Buton => "ACTION",
            YetkiIslemTipi.Tab => "TAB",
            YetkiIslemTipi.Page => "", // Page i√ßin prefix yok
            _ => ""
        };

        // √úst i≈ülem varsa onun adƒ±nƒ± al
        if (SelectedUstIslemId > 0)
        {
            var ustIslem = FilteredIslemler.FirstOrDefault(i => i.ModulControllerIslemId == SelectedUstIslemId);
            if (ustIslem != null)
            {
                // √úst i≈ülemin adƒ±nƒ± al
                var ustIslemAdi = ustIslem.ModulControllerIslemAdi?.ToUpperInvariant() ?? "";

                // Tip prefix varsa ekle
                if (!string.IsNullOrEmpty(tipPrefix))
                    PermissionKey = $"{modulKodu}.{controllerAdi}.{ustIslemAdi}.{tipPrefix}.{islemAdi}";
                else
                    PermissionKey = $"{modulKodu}.{controllerAdi}.{ustIslemAdi}.{islemAdi}";
                return;
            }
        }

        // √úst i≈ülem yoksa direkt olu≈ütur
        if (!string.IsNullOrEmpty(tipPrefix))
            PermissionKey = $"{modulKodu}.{controllerAdi}.{tipPrefix}.{islemAdi}";
        else
            PermissionKey = $"{modulKodu}.{controllerAdi}.{islemAdi}";
    }

    private string GetIslemPrefix(ModulControllerIslemResponseDto islem)
    {
        return islem.IslemTipi switch
        {
            YetkiIslemTipi.Page => "üìÑ",
            YetkiIslemTipi.Tab => "üìë",
            YetkiIslemTipi.Buton => "üîò",
            YetkiIslemTipi.Field => "üìù",
            YetkiIslemTipi.FormField => "‚úèÔ∏è",
            _ => "‚Ä¢"
        };
    }

    private async Task LoadData()
    {
        IsLoading = true;
        var result = await IslemApiService.GetAllAsync();
        if (result.Success && result.Data != null)
            Islemler = result.Data;
        IsLoading = false;
    }

    private async Task LoadDtoTypes()
    {
        IsLoadingDtoTypes = true;
        try
        {
            var result = await DtoDiscoveryApiService.GetAllDtoTypesAsync();
            if (result.Success && result.Data != null)
            {
                DtoTypes = result.Data;
            }
            else
            {
                await ToastService.ShowErrorAsync(result.Message?.FirstOrDefault() ?? "DTO'lar y√ºklenemedi");
            }
        }
        catch (Exception ex)
        {
            await ToastService.ShowErrorAsync($"DTO y√ºkleme hatasƒ±: {ex.Message}");
        }
        finally
        {
            IsLoadingDtoTypes = false;
        }
    }

    private async Task LoadDtoFields(string dtoTypeName)
    {
        IsLoadingDtoFields = true;
        try
        {
            var result = await DtoDiscoveryApiService.GetDtoPropertiesAsync(dtoTypeName);
            if (result.Success && result.Data != null)
            {
                DtoFields = result.Data;
            }
            else
            {
                await ToastService.ShowErrorAsync(result.Message?.FirstOrDefault() ?? "Field'lar y√ºklenemedi");
            }
        }
        catch (Exception ex)
        {
            await ToastService.ShowErrorAsync($"Field y√ºkleme hatasƒ±: {ex.Message}");
        }
        finally
        {
            IsLoadingDtoFields = false;
        }
    }

    private void ShowAddModal()
    {
        EditingId = null;
        SelectedModulId = 0;
        SelectedControllerId = 0;
        SelectedUstIslemId = 0;
        FilteredControllers = new();
        FilteredIslemler = new();
        IslemAdi = string.Empty;
        Route = null;
        PermissionKey = null;
        SelectedSayfaTipi = SayfaTipi.Protected;
        SelectedMinYetki = YetkiSeviyesi.View;
        SelectedIslemTipi = YetkiIslemTipi.Page;
        DtoTypeName = null;
        DtoFieldName = null;
        ShowModal = true;
    }

    private async Task StartEdit(ModulControllerIslemResponseDto i)
    {
        EditingId = i.ModulControllerIslemId;
        SelectedModulId = i.ModulId;
        await OnModulChanged();
        SelectedControllerId = i.ModulControllerId;
        OnControllerChanged();
        IslemAdi = i.ModulControllerIslemAdi;
        Route = i.Route;
        PermissionKey = i.PermissionKey;
        SelectedSayfaTipi = i.SayfaTipi;
        SelectedMinYetki = i.MinYetkiSeviyesi;
        SelectedIslemTipi = i.IslemTipi;
        SelectedUstIslemId = i.UstIslemId ?? 0;
        DtoTypeName = i.DtoTypeName;
        DtoFieldName = i.DtoFieldName;

        // DTO Type varsa field'larƒ± y√ºkle
        if (!string.IsNullOrEmpty(DtoTypeName))
        {
            await LoadDtoFields(DtoTypeName);
        }

        ShowModal = true;
    }

    private void CloseModal()
    {
        ShowModal = false;
        EditingId = null;
    }

    private async Task SaveIslem()
    {
        if (SelectedControllerId <= 0 || string.IsNullOrWhiteSpace(IslemAdi))
        {
            await ToastService.ShowWarningAsync("Controller ve ƒ∞≈ülem adƒ± zorunludur");
            return;
        }

        if (string.IsNullOrWhiteSpace(PermissionKey))
        {
            await ToastService.ShowWarningAsync("Permission Key otomatik olu≈üturulamadƒ±. L√ºtfen gerekli alanlarƒ± doldurun.");
            return;
        }

        // Field tipi i√ßin DTO Field Name zorunlu
        if (IsFieldType && string.IsNullOrWhiteSpace(DtoFieldName))
        {
            await ToastService.ShowWarningAsync("Field tipi i√ßin DTO Field Name zorunludur");
            return;
        }

        IsSaving = true;
        StateHasChanged();

        if (EditingId.HasValue)
        {
            var request = new ModulControllerIslemUpdateRequestDto
            {
                ModulControllerId = SelectedControllerId,
                ModulControllerIslemAdi = IslemAdi.Trim(),
                IslemTipi = SelectedIslemTipi,
                UstIslemId = SelectedUstIslemId > 0 ? SelectedUstIslemId : null,
                Route = string.IsNullOrWhiteSpace(Route) ? null : Route.Trim(),
                PermissionKey = string.IsNullOrWhiteSpace(PermissionKey) ? null : PermissionKey.Trim(),
                SayfaTipi = SelectedSayfaTipi,
                MinYetkiSeviyesi = SelectedMinYetki,
                DtoTypeName = string.IsNullOrWhiteSpace(DtoTypeName) ? null : DtoTypeName.Trim(),
                DtoFieldName = string.IsNullOrWhiteSpace(DtoFieldName) ? null : DtoFieldName.Trim()
            };
            var result = await IslemApiService.UpdateAsync(EditingId.Value, request);
            if (result.Success)
                await ToastService.ShowSuccessAsync(result.Message ?? "ƒ∞≈ülem g√ºncellendi");
            else
                await ToastService.ShowErrorAsync(result.Message ?? "ƒ∞≈ülem g√ºncellenemedi");
        }
        else
        {
            var request = new ModulControllerIslemCreateRequestDto
            {
                ModulControllerId = SelectedControllerId,
                ModulControllerIslemAdi = IslemAdi.Trim(),
                IslemTipi = SelectedIslemTipi,
                UstIslemId = SelectedUstIslemId > 0 ? SelectedUstIslemId : null,
                Route = string.IsNullOrWhiteSpace(Route) ? null : Route.Trim(),
                PermissionKey = string.IsNullOrWhiteSpace(PermissionKey) ? null : PermissionKey.Trim(),
                SayfaTipi = SelectedSayfaTipi,
                MinYetkiSeviyesi = SelectedMinYetki,
                DtoTypeName = string.IsNullOrWhiteSpace(DtoTypeName) ? null : DtoTypeName.Trim(),
                DtoFieldName = string.IsNullOrWhiteSpace(DtoFieldName) ? null : DtoFieldName.Trim()
            };
            var result = await IslemApiService.CreateAsync(request);
            if (result.Success)
                await ToastService.ShowSuccessAsync(result.Message ?? "ƒ∞≈ülem eklendi");
            else
                await ToastService.ShowErrorAsync(result.Message ?? "ƒ∞≈ülem eklenemedi");
        }

        IsSaving = false;
        CloseModal();
        await LoadData();
    }

    private async Task DeleteIslem(ModulControllerIslemResponseDto i)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", $"'{i.ModulControllerIslemAdi}' silinsin mi?");
        if (!confirmed) return;

        var result = await IslemApiService.DeleteAsync(i.ModulControllerIslemId);
        if (result.Success)
            await ToastService.ShowSuccessAsync(result.Message ?? "ƒ∞≈ülem silindi");
        else
            await ToastService.ShowErrorAsync(result.Message ?? "ƒ∞≈ülem silinemedi");
        await LoadData();
    }
}
