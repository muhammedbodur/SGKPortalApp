@page "/log/detail/{LogId:int}"
@using SGKPortalApp.PresentationLayer.Services.ApiServices.Interfaces.Common
@using SGKPortalApp.BusinessObjectLayer.DTOs.AuditLog
@using SGKPortalApp.BusinessObjectLayer.Enums.Common
@inject IAuditLogApiService AuditLogApiService
@inject NavigationManager NavigationManager

<PageTitle>Log Detay - SGK Portal</PageTitle>

<div class="container-fluid">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">Log detayƒ± y√ºkleniyor...</p>
        </div>
    }
    else if (detail == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Log bulunamadƒ±.
        </div>
        <a href="/log" class="btn btn-secondary">‚Üê Geri D√∂n</a>
    }
    else
    {
        @* Ba≈ülƒ±k *@
        <div class="row mb-3">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3>üìã Log Detayƒ±</h3>
                        <p class="text-muted mb-0">Log ID: #@LogId</p>
                    </div>
                    <a href="/log" class="btn btn-secondary">‚Üê Geri D√∂n</a>
                </div>
            </div>
        </div>

        @* Genel Bilgiler *@
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h5 class="mb-0">‚ÑπÔ∏è Genel Bilgiler</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tbody>
                                <tr>
                                    <th style="width: 150px">Tarih/Saat:</th>
                                    <td>@detail.IslemZamani.ToLocalTime().ToString("dd.MM.yyyy HH:mm:ss")</td>
                                </tr>
                                <tr>
                                    <th>Kullanƒ±cƒ± TC:</th>
                                    <td>@detail.TcKimlikNo</td>
                                </tr>
                                <tr>
                                    <th>Tablo:</th>
                                    <td><span class="badge bg-info">@detail.TabloAdi</span></td>
                                </tr>
                                <tr>
                                    <th>ƒ∞≈ülem T√ºr√º:</th>
                                    <td>
                                        <span class="badge @GetActionBadgeClass(detail.IslemTuru)">
                                            @detail.IslemTuru.ToString()
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tbody>
                                <tr>
                                    <th style="width: 150px">Depolama:</th>
                                    <td>@detail.StorageType.ToString()</td>
                                </tr>
                                <tr>
                                    <th>IP Adresi:</th>
                                    <td>@(detail.IpAddress ?? "-")</td>
                                </tr>
                                <tr>
                                    <th>User Agent:</th>
                                    <td><small>@(detail.UserAgent ?? "-")</small></td>
                                </tr>
                                <tr>
                                    <th>Data Boyutu:</th>
                                    <td>@(detail.DataSizeBytes.HasValue ? $"{detail.DataSizeBytes.Value} bytes" : "-")</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        @* Deƒüi≈üiklik Detaylarƒ± *@
        @if (detail.FieldChanges.Any())
        {
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üîÑ Deƒüi≈üen Alanlar (@detail.FieldChanges.Count alan)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%">Alan Adƒ±</th>
                                    <th style="width: 37.5%">Eski Deƒüer (Before)</th>
                                    <th style="width: 37.5%">Yeni Deƒüer (After)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var change in detail.FieldChanges)
                                {
                                    <tr class="table-warning">
                                        <td><strong>@change.FieldName</strong></td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(change.OldValue))
                                            {
                                                <code>@change.OldValue</code>
                                            }
                                            else
                                            {
                                                <span class="text-muted fst-italic">bo≈ü</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(change.NewValue))
                                            {
                                                <code>@change.NewValue</code>
                                            }
                                            else
                                            {
                                                <span class="text-muted fst-italic">bo≈ü</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Bu i≈ülemde hi√ßbir alan deƒüi≈ümedi.
            </div>
        }

        @* Transaction Grubu (Varsa) *@
        @if (detail.TransactionId.HasValue && detail.RelatedLogs?.Any() == true)
        {
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        üîó Transaction Grubu
                        <span class="text-muted">#@detail.TransactionId.Value.ToString().Substring(0, 8)</span>
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Bu log, @detail.RelatedLogs.Count adet diƒüer log ile aynƒ± transaction i√ßinde ger√ßekle≈ütirildi.
                    </p>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Tablo</th>
                                    <th>ƒ∞≈ülem</th>
                                    <th>Tarih/Saat</th>
                                    <th>Deƒüi≈üen Alanlar</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var relatedLog in detail.RelatedLogs.OrderBy(l => l.IslemZamani))
                                {
                                    <tr>
                                        <td><span class="badge bg-info">@relatedLog.TabloAdi</span></td>
                                        <td>
                                            <span class="badge @GetActionBadgeClass(relatedLog.IslemTuru)">
                                                @relatedLog.IslemTuruText
                                            </span>
                                        </td>
                                        <td><small>@relatedLog.IslemZamaniText</small></td>
                                        <td>
                                            @if (relatedLog.ChangedFieldCount.HasValue)
                                            {
                                                <small class="text-muted">@relatedLog.ChangedFieldCount alan</small>
                                            }
                                            else
                                            {
                                                <small class="text-muted">-</small>
                                            }
                                        </td>
                                        <td>
                                            <a href="/log/detail/@relatedLog.DatabaseLogId" class="btn btn-sm btn-outline-primary">
                                                Detay
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        @* Alt Buton *@
        <div class="text-center mb-4">
            <a href="/log" class="btn btn-secondary">‚Üê Log Listesine D√∂n</a>
        </div>
    }
</div>

@code {
    [Parameter]
    public int LogId { get; set; }

    private AuditLogDetailDto? detail;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDetailAsync();
    }

    private async Task LoadDetailAsync()
    {
        isLoading = true;
        try
        {
            detail = await AuditLogApiService.GetLogDetailAsync(LogId);
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetActionBadgeClass(DatabaseAction action)
    {
        return action switch
        {
            DatabaseAction.INSERT or DatabaseAction.CREATE_COMPLETE => "bg-success",
            DatabaseAction.UPDATE or DatabaseAction.UPDATE_COMPLETE => "bg-warning text-dark",
            DatabaseAction.DELETE => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
