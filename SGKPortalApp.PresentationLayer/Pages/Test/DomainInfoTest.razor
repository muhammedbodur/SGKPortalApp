@page "/test/domain-info"
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Domain Bilgisi Test</PageTitle>

<div class="container mt-4">
    <h2>ğŸ” Domain Bilgisi Test SayfasÄ±</h2>
    <p class="text-muted">Bu sayfa domain bilgilerini alÄ±p alamadÄ±ÄŸÄ±mÄ±zÄ± test eder.</p>

    <hr />

    <!-- Test 1: Server-Side Bilgiler -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5>Test 1: Server-Side Domain Bilgileri</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-primary" @onclick="GetServerInfo">
                ğŸ–¥ï¸ Server Bilgilerini Al
            </button>

            @if (serverInfo != null)
            {
                <div class="mt-3">
                    <pre class="bg-light p-3">@serverInfo</pre>
                </div>
            }
        </div>
    </div>

    <!-- Test 2: Email'den VarsayÄ±m -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h5>Test 2: Email'den Domain User VarsayÄ±mÄ±</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Email:</label>
                <input type="email" class="form-control" @bind="testEmail"
                       placeholder="ornek: ahmet.yilmaz@sgk.gov.tr" />
            </div>
            <button class="btn btn-success" @onclick="TestEmailToDomain">
                âœ‰ï¸ Email'den Domain User Hesapla
            </button>

            @if (emailResult != null)
            {
                <div class="mt-3">
                    <pre class="bg-light p-3">@emailResult</pre>
                </div>
            }
        </div>
    </div>

    <!-- Test 3: Client-Side Bilgiler -->
    <div class="card mb-3">
        <div class="card-header bg-warning text-dark">
            <h5>Test 3: Client-Side Bilgiler (JavaScript)</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-warning" @onclick="GetClientInfo">
                ğŸ’» Browser Bilgilerini Al
            </button>

            @if (clientInfo != null)
            {
                <div class="mt-3">
                    <pre class="bg-light p-3">@clientInfo</pre>
                </div>
            }
        </div>
    </div>

    <!-- SonuÃ§ ve Ã–neriler -->
    <div class="alert alert-info">
        <h5>ğŸ“‹ SonuÃ§lar:</h5>
        <ul>
            <li><strong>Server bilgileri:</strong> Server process'in Ã§alÄ±ÅŸtÄ±ÄŸÄ± user'Ä± gÃ¶sterir (genelde IIS AppPool)</li>
            <li><strong>Email varsayÄ±mÄ±:</strong> En pratik yÃ¶ntem. Email'den domain username Ã§Ä±karÄ±lÄ±r.</li>
            <li><strong>Client bilgileri:</strong> Browser'dan domain bilgisi alÄ±namaz (gÃ¼venlik kÄ±sÄ±tlamasÄ±)</li>
        </ul>
        <hr />
        <h6>ğŸ’¡ Ã–neri:</h6>
        <p>
            <strong>Email'den varsayÄ±m</strong> yÃ¶ntemi kullanÄ±lmasÄ± Ã¶nerilir:<br />
            <code>ahmet.yilmaz@sgk.gov.tr</code> â†’ <code>SGKDOMAIN\ahmet.yilmaz</code>
        </p>
    </div>
</div>

@code {
    private string? serverInfo;
    private string? emailResult;
    private string? clientInfo;
    private string testEmail = "ahmet.yilmaz@sgk.gov.tr";

    private async Task GetServerInfo()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<object>("/api/TestDomainInfo/server-info");
            serverInfo = System.Text.Json.JsonSerializer.Serialize(response,
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        }
        catch (Exception ex)
        {
            serverInfo = $"Hata: {ex.Message}";
        }
    }

    private async Task TestEmailToDomain()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<object>($"/api/TestDomainInfo/ad-query?email={testEmail}");
            emailResult = System.Text.Json.JsonSerializer.Serialize(response,
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        }
        catch (Exception ex)
        {
            emailResult = $"Hata: {ex.Message}";
        }
    }

    private async Task GetClientInfo()
    {
        try
        {
            // JavaScript ile browser bilgilerini al
            var jsInfo = await JS.InvokeAsync<ClientJsInfo>("getClientInfo");

            var clientRequest = new
            {
                UserAgent = jsInfo.UserAgent,
                Platform = jsInfo.Platform,
                Language = jsInfo.Language,
                ScreenResolution = jsInfo.ScreenResolution,
                TimeZone = jsInfo.TimeZone
            };

            var response = await Http.PostAsJsonAsync("/api/TestDomainInfo/client-info", clientRequest);
            var result = await response.Content.ReadAsStringAsync();

            clientInfo = System.Text.Json.JsonSerializer.Serialize(
                System.Text.Json.JsonSerializer.Deserialize<object>(result),
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        }
        catch (Exception ex)
        {
            clientInfo = $"Hata: {ex.Message}";
        }
    }

    public class ClientJsInfo
    {
        public string UserAgent { get; set; } = "";
        public string Platform { get; set; } = "";
        public string Language { get; set; } = "";
        public string ScreenResolution { get; set; } = "";
        public string TimeZone { get; set; } = "";
    }
}
