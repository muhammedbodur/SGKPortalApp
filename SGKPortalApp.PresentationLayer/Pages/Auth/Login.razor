@page "/auth/login"
@layout EmptyLayout
@using SGKPortalApp.BusinessObjectLayer.DTOs.Request.Auth

<PageTitle>GiriÅŸ Yap - SGK Portal</PageTitle>

<!-- Content -->
<div class="container-xxl">
    <div class="authentication-wrapper authentication-basic container-p-y">
        <div class="authentication-inner">
            <!-- Login Card -->
            <div class="card">
                <div class="card-body">
                    <!-- Logo -->
                    <div class="app-brand justify-content-center mb-4">
                        <a href="/" class="app-brand-link gap-2">
                            <SgkLogo Width="120" Height="48" />
                            <span class="app-brand-text demo text-body fw-bold fs-4">SGK Portal</span>
                        </a>
                    </div>
                    <!-- /Logo -->
                    
                    <h4 class="mb-2">HoÅŸ Geldiniz! ğŸ‘‹</h4>

                    @if (isDomainJoined)
                    {
                        <p class="mb-4">
                            <i class="bx bx-network-chart text-success me-1"></i>
                            Domain: <strong>@domainName</strong>
                            <br />
                            <small class="text-muted">LÃ¼tfen domain kullanÄ±cÄ± adÄ±nÄ±z ve ÅŸifreniz ile giriÅŸ yapÄ±n</small>
                        </p>
                    }
                    else
                    {
                        <p class="mb-4">LÃ¼tfen TC Kimlik NumaranÄ±z ve ÅŸifreniz ile giriÅŸ yapÄ±n</p>
                    }

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible" role="alert">
                            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                            <i class="bx bx-error-circle me-2"></i>
                            @errorMessage
                        </div>
                    }

                    <EditForm Model="@loginModel" OnValidSubmit="HandleLogin" class="mb-3">
                        <DataAnnotationsValidator />

                        @if (loginModel.Mode == LoginMode.Standard)
                        {
                            <!-- TC Kimlik No (Standart Login) -->
                            <div class="mb-3">
                                <label for="tcKimlikNo" class="form-label">TC Kimlik No</label>
                                <InputText @bind-Value="loginModel.TcKimlikNo"
                                           class="form-control"
                                           id="tcKimlikNo"
                                           placeholder="11 haneli TC Kimlik No"
                                           maxlength="11"
                                           autofocus
                                           required />
                                <ValidationMessage For="@(() => loginModel.TcKimlikNo)" class="text-danger" />
                            </div>
                        }
                        else
                        {
                            <!-- Domain Username (Active Directory Login) -->
                            <div class="mb-3">
                                <label for="domainUsername" class="form-label">
                                    <i class="bx bx-user me-1"></i>
                                    Domain KullanÄ±cÄ± AdÄ±
                                </label>
                                <InputText @bind-Value="loginModel.DomainUsername"
                                           class="form-control"
                                           id="domainUsername"
                                           placeholder="Ã–rnek: mbodur3"
                                           autofocus
                                           required />
                                <small class="form-text text-muted">Domain prefix olmadan sadece kullanÄ±cÄ± adÄ±nÄ±zÄ± girin</small>
                                <ValidationMessage For="@(() => loginModel.DomainUsername)" class="text-danger" />
                            </div>
                        }

                        <!-- Åifre -->
                        <div class="mb-3 form-password-toggle">
                            <div class="d-flex justify-content-between">
                                <label class="form-label" for="password">Åifre</label>
                                <a href="/auth/forgot-password">
                                    <small>Åifremi Unuttum?</small>
                                </a>
                            </div>
                            <div class="input-group input-group-merge">
                                <InputText type="@(showPassword ? "text" : "password")" 
                                           @bind-Value="loginModel.Password" 
                                           class="form-control" 
                                           id="password" 
                                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                                <span class="input-group-text cursor-pointer" @onclick="TogglePasswordVisibility">
                                    <i class="bx @(showPassword ? "bx-show" : "bx-hide")"></i>
                                </span>
                            </div>
                            <ValidationMessage For="@(() => loginModel.Password)" class="text-danger" />
                        </div>

                        <!-- Beni HatÄ±rla -->
                        <div class="mb-3">
                            <div class="form-check">
                                <InputCheckbox @bind-Value="loginModel.RememberMe" class="form-check-input" id="remember-me" />
                                <label class="form-check-label" for="remember-me">
                                    Beni HatÄ±rla
                                </label>
                            </div>
                        </div>

                        <!-- GiriÅŸ Butonu -->
                        <div class="mb-3">
                            <button class="btn btn-primary d-grid w-100" type="submit" disabled="@isLoading">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>GiriÅŸ yapÄ±lÄ±yor...</span>
                                }
                                else
                                {
                                    <span>GiriÅŸ Yap</span>
                                }
                            </button>
                        </div>
                    </EditForm>

                    <p class="text-center">
                        <small class="text-muted">
                            @if (loginModel.Mode == LoginMode.Standard)
                            {
                                <span>Ä°lk kez giriÅŸ yapÄ±yorsanÄ±z, ÅŸifreniz TC Kimlik NumaranÄ±z ile aynÄ±dÄ±r.</span>
                            }
                            else
                            {
                                <span>Domain ÅŸifrenizi kullanarak giriÅŸ yapÄ±n.</span>
                            }
                        </small>
                    </p>
                </div>
            </div>
            <!-- /Login Card -->
        </div>
    </div>
</div>
<!-- / Content -->

<script>
    // Login sayfasÄ± yÃ¼klendiÄŸinde tÃ¼m client-side verileri temizle
    (function() {
        console.log('ğŸ§¹ Login: Client-side temizlik baÅŸlatÄ±lÄ±yor...');
        
        try {
            // Mevcut tab/session bilgilerini ÅŸimdilik sakla
            const preservedTabSessionId = sessionStorage.getItem('portal.tabSessionId');
            const preservedHasVisited = sessionStorage.getItem('portal.hasVisited');

            // 1. LocalStorage temizle
            localStorage.removeItem('callPanelIsPinned');
            localStorage.removeItem('callPanelIsVisible');
            localStorage.removeItem('bankoMode');
            localStorage.removeItem('activeBankoId');
            console.log('âœ… LocalStorage temizlendi');
            
            // 2. SessionStorage temizle
            sessionStorage.clear();
            if (preservedTabSessionId) {
                sessionStorage.setItem('portal.tabSessionId', preservedTabSessionId);
                console.log('â™»ï¸ portal.tabSessionId korundu');
            }
            if (preservedHasVisited) {
                sessionStorage.setItem('portal.hasVisited', preservedHasVisited);
                console.log('â™»ï¸ portal.hasVisited korundu');
            }
            console.log('âœ… SessionStorage temizlendi');
            
            // 3. SÄ±ra Ã‡aÄŸÄ±rma Paneli'ni temizle (varsa)
            if (typeof SiraCagirmaPanel !== 'undefined') {
                try {
                    SiraCagirmaPanel.setPin(false);
                    SiraCagirmaPanel.closePanel();
                    SiraCagirmaPanel.destroy();
                    console.log('âœ… SÄ±ra Ã‡aÄŸÄ±rma Paneli temizlendi');
                } catch (e) {
                    console.warn('âš ï¸ SÄ±ra Ã‡aÄŸÄ±rma Paneli temizlenirken hata:', e);
                }
            }
            
            // 4. Banko Mode state'ini temizle (varsa)
            if (typeof BankoMode !== 'undefined') {
                try {
                    BankoMode.cleanup();
                    console.log('âœ… Banko Mode temizlendi');
                } catch (e) {
                    console.warn('âš ï¸ Banko Mode temizlenirken hata:', e);
                }
            }

            // 5. SignalR guard'larÄ±nÄ± sÄ±fÄ±rla
            try {
                if (window.signalRManager?.stop) {
                    window.signalRManager.stop();
                }
                delete window.signalRManager;
                delete window.signalRApp;
                delete window.signalRAppInitialized;
                console.log('â™»ï¸ SignalR guard deÄŸerleri sÄ±fÄ±rlandÄ±');
            } catch (e) {
                console.warn('âš ï¸ SignalR guard temizlenirken hata:', e);
            }
            
            console.log('âœ… Login: Client-side temizlik tamamlandÄ±');
        } catch (error) {
            console.error('âŒ Login temizlik hatasÄ±:', error);
        }
    })();

    window.submitLoginForm = async function(loginDataJson) {
        console.log('ğŸ”µ 7. submitLoginForm Ã§aÄŸrÄ±ldÄ±');
        
        try {
            // Fetch API ile POST yap - cookie'ler otomatik gÃ¶nderilir/alÄ±nÄ±r
            console.log('ğŸ”µ 8. LoginHandler\'a POST yapÄ±lÄ±yor...');
            
            const response = await fetch('/auth/loginhandler', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: loginDataJson,
                credentials: 'same-origin' // Cookie'leri dahil et
            });
            
            console.log('ğŸ”µ 9. Response alÄ±ndÄ±:', response.status);
            
            if (response.ok) {
                // LoginHandler redirect dÃ¶ndÃ¼, takip et
                console.log('ğŸ”µ 10. Cookie set edildi, ana sayfaya yÃ¶nlendiriliyor...');
                window.location.href = '/';
            } else {
                const errorData = await response.json();
                console.error('âŒ LoginHandler hatasÄ±:', errorData);
                alert('Oturum oluÅŸturulamadÄ±: ' + (errorData.message || 'Bilinmeyen hata'));
            }
        } catch (error) {
            console.error('âŒ submitLoginForm hatasÄ±:', error);
            alert('Bir hata oluÅŸtu: ' + error.message);
        }
    };
</script>

