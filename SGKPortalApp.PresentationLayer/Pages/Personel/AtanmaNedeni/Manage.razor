@page "/personel/atanma-nedeni/manage"
@page "/personel/atanma-nedeni/manage/{Id:int}"
@inherits SGKPortalApp.PresentationLayer.Components.Base.FieldPermissionPageBase
@using SGKPortalApp.BusinessObjectLayer.DTOs.Request.PersonelIslemleri

<PageTitle>@(IsEditMode ? "Atanma Nedeni D√ºzenle" : "Yeni Atanma Nedeni") - SGK Portal</PageTitle>


@if (!CanViewPage)
{
    <div class="alert alert-danger" role="alert">
        <i class="bx bx-lock-alt me-2"></i>
        Bu sayfayƒ± g√∂r√ºnt√ºleme yetkiniz bulunmuyor.
    </div>
}
else
{
    <FieldPermissionScope PageKey="@ResolvedPermissionKey" IsEditMode="true">
        <div class="container-xxl flex-grow-1 container-p-y">
            <!-- BREADCRUMB -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb breadcrumb-style1">
                    <li class="breadcrumb-item">
                        <a href="javascript:void(0);" @onclick="NavigateToHome">
                            <i class="bx bx-home-alt me-1"></i>Ana Sayfa
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="javascript:void(0);" @onclick="NavigateToList">
                            Atanma Nedenleri
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        @(IsEditMode ? "D√ºzenle" : "Yeni Atanma Nedeni")
                    </li>
                </ol>
            </nav>

            <!-- PAGE HEADER -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="fw-bold mb-1">
                        <i class="bx @(IsEditMode ? "bx-edit" : "bx-plus-circle") me-2"></i>
                        @(IsEditMode ? "Atanma Nedeni D√ºzenle" : "Yeni Atanma Nedeni Ekle")
                    </h4>
                    <p class="text-muted mb-0">
                        @(IsEditMode ? "Atanma nedeni bilgilerini g√ºncelleyin" : "Yeni bir atanma nedeni olu≈üturun")
                    </p>
                </div>

                <button class="btn btn-outline-secondary" @onclick="NavigateToList">
                    <i class="bx bx-arrow-back me-1"></i>Geri D√∂n
                </button>
            </div>

            @if (IsLoading)
            {
                <!-- Loading State -->
                <div class="card">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Y√ºkleniyor...</span>
                        </div>
                        <p class="text-muted">@(IsEditMode ? "Atanma nedeni bilgileri y√ºkleniyor..." : "Hazƒ±rlanƒ±yor...")</p>
                    </div>
                </div>
            }
            else
            {
                <!-- FORM CARD -->
                <div class="row">
                    <div class="col-lg-8 col-xl-6 mx-auto">
                        <div class="card">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <h5 class="mb-0">
                                    <i class="bx bx-info-circle me-2"></i>Atanma Nedeni Bilgileri
                                </h5>
                                @if (IsEditMode)
                                {
                                    <span class="badge bg-label-info">ID: @Id</span>
                                }
                            </div>

                            <div class="card-body">
                                <EditForm Model="@FormModel" OnValidSubmit="HandleSubmit">
                                    <DataAnnotationsValidator />

                                    <!-- Atanma Nedeni -->
                                    <div class="mb-3">
                                        <label class="form-label required">
                                            <i class="bx bx-file me-1"></i>Atanma Nedeni
                                        </label>
                                        <InputText @bind-Value="FormModel.AtanmaNedeni"
                                                   class="form-control"
                                                   placeholder="√ñrn: Naklen Atama"
                                                   maxlength="200"
                                                   disabled="@IsSaving" />
                                        <ValidationMessage For="@(() => FormModel.AtanmaNedeni)" class="text-danger small mt-1" />

                                        <!-- Karakter Sayacƒ± -->
                                        <div class="form-text">
                                            @FormModel.AtanmaNedeni.Length / 200 karakter
                                        </div>
                                    </div>

                                    <!-- Validation Summary -->
                                    <ValidationSummary class="alert alert-danger" />

                                    <!-- Action Buttons -->
                                    <div class="d-flex gap-2 justify-content-end pt-3 border-top">
                                        <button type="button"
                                                class="btn btn-outline-secondary"
                                                @onclick="NavigateToList"
                                                disabled="@IsSaving">
                                            <i class="bx bx-x me-1"></i>ƒ∞ptal
                                        </button>

                                        <button type="submit"
                                                class="btn btn-primary"
                                                disabled="@IsSaving">
                                            @if (IsSaving)
                                            {
                                                <span class="spinner-border spinner-border-sm me-1"></span>
                                                <span>Kaydediliyor...</span>
                                            }
                                            else
                                            {
                                                <i class="bx bx-check me-1"></i>
                                                <span>@(IsEditMode ? "G√ºncelle" : "Kaydet")</span>
                                            }
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>

                        <!-- Delete Button (Edit Mode Only) -->
                        @if (IsEditMode)
                        {
                            <div class="card border-danger mt-4">
                                <div class="card-body">
                                    <h6 class="text-danger mb-2">
                                        <i class="bx bx-error-circle me-1"></i>Tehlikeli B√∂lge
                                    </h6>
                                    <p class="text-muted mb-3 small">
                                        Bu atanma nedenini silmek istiyorsanƒ±z, a≈üaƒüƒ±daki butona tƒ±klayƒ±n.
                                        Bu i≈ülem geri alƒ±namaz.
                                    </p>
                                    <button class="btn btn-outline-danger"
                                            @onclick="ShowDeleteConfirmation"
                                            disabled="@IsSaving">
                                        <i class="bx bx-trash me-1"></i>Atanma Nedenini Sil
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </FieldPermissionScope>
}


<!-- DELETE CONFIRMATION MODAL -->
@if (ShowDeleteModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bx bx-trash text-danger me-2"></i>Atanma Nedeni Sil
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteModal" disabled="@IsDeleting"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger mb-3">
                        <div class="d-flex align-items-start">
                            <i class="bx bx-error-circle me-2 fs-5"></i>
                            <div>
                                <strong>üóëÔ∏è Dikkat!</strong> Kalƒ±cƒ± silme i≈ülemi yapƒ±yorsunuz.
                                <p class="mb-0 mt-2">
                                    <strong>@FormModel.AtanmaNedeni</strong> Atanma Nedenini silmek istediƒüinizden emin misiniz?
                                </p>
                            </div>
                        </div>
                    </div>

                    @if (DeletePersonelSayisi > 0)
                    {
                        <div class="alert alert-warning mb-3">
                            <i class="bx bx-error-circle me-2"></i>
                            <strong>Uyarƒ±:</strong> Bu atanma nedenine baƒülƒ± <strong>@DeletePersonelSayisi aktif personel</strong> bulunmaktadƒ±r!
                        </div>
                    }

                    <p class="mb-2"><strong>Silme i≈ülemi sonrasƒ±nda:</strong></p>
                    <ul class="text-muted mb-3">
                        <li><strong>Atanma nedeni kaydƒ± kalƒ±cƒ± olarak silinecektir</strong></li>
                        @if (DeletePersonelSayisi > 0)
                        {
                            <li class="text-danger"><strong>Bu i≈ülem personel sayƒ±sƒ± nedeniyle ba≈üarƒ±sƒ±z olacaktƒ±r</strong></li>
                            <li>√ñnce t√ºm personellerin atanma nedenlerini deƒüi≈ütirmelisiniz</li>
                        }
                        else
                        {
                            <li>Bu i≈ülem geri alƒ±namaz</li>
                        }
                    </ul>

                    @if (DeletePersonelSayisi > 0)
                    {
                        <p class="text-danger mb-0">
                            <small><strong>Not:</strong> Silme i≈ülemine devam etmek i√ßin √∂nce t√ºm personellerin atanma nedenlerini deƒüi≈ütirmeniz gerekmektedir.</small>
                        </p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal" disabled="@IsDeleting">
                        ƒ∞ptal
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@IsDeleting">
                        @if (IsDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            <span>Siliniyor...</span>
                        }
                        else
                        {
                            <i class="bx bx-trash me-1"></i>
                            <span>Evet, Sil</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .required::after {
        content: " *";
        color: #ff0000;
    }
</style>
