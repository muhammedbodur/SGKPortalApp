@page "/account/forgot-password"
@layout EmptyLayout

<PageTitle>Şifremi Unuttum - SGK Portal</PageTitle>

<div class="authentication-wrapper authentication-cover">
    <div class="authentication-inner row m-0">
        <!-- Left Side - Illustration -->
        <div class="d-none d-lg-flex col-lg-7 col-xl-8 align-items-center p-5" style="background: linear-gradient(135deg, #696cff 0%, #5f61e6 100%);">
            <div class="w-100 d-flex flex-column align-items-center justify-content-center">
                <img src="/portal/assets/img/illustrations/forgot-password-illustration.png"
                     class="img-fluid mb-4"
                     alt="Şifremi Unuttum"
                     style="max-width: 400px;"
                     onerror="this.style.display='none'" />
                <div class="text-center text-white">
                    <h3 class="mb-2">SGK İzmir İl Müdürlüğü</h3>
                    <p class="opacity-75">Kurum İçi Portal Sistemi</p>
                </div>
            </div>
        </div>

        <!-- Right Side - Form -->
        <div class="d-flex col-12 col-lg-5 col-xl-4 align-items-center authentication-bg p-sm-5 p-4">
            <div class="w-px-400 mx-auto">
                <!-- Logo -->
                <div class="text-center mb-4">
                    <img src="/portal/assets/img/sgk-logo.png" alt="SGK Logo" style="height: 60px;" onerror="this.style.display='none'" />
                </div>

                @if (CurrentStep == Step.VerifyIdentity)
                {
                    <!-- Step 1: Identity Verification -->
                    <h4 class="mb-2 text-center">Kimlik Doğrulama</h4>
                    <p class="mb-4 text-center text-muted">
                        Şifrenizi sıfırlamak için kimlik bilgilerinizi doğrulayın.
                    </p>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger d-flex align-items-center" role="alert">
                            <i class="bx bx-error-circle me-2"></i>
                            <span>@ErrorMessage</span>
                        </div>
                    }

                    <!-- Progress Steps -->
                    <div class="d-flex justify-content-between mb-4">
                        <div class="text-center flex-fill">
                            <div class="avatar avatar-sm mx-auto mb-1">
                                <span class="avatar-initial rounded-circle bg-primary">1</span>
                            </div>
                            <small class="text-primary fw-semibold">Kimlik Doğrulama</small>
                        </div>
                        <div class="text-center flex-fill">
                            <div class="avatar avatar-sm mx-auto mb-1">
                                <span class="avatar-initial rounded-circle bg-label-secondary">2</span>
                            </div>
                            <small class="text-muted">Güvenlik Sorusu</small>
                        </div>
                        <div class="text-center flex-fill">
                            <div class="avatar avatar-sm mx-auto mb-1">
                                <span class="avatar-initial rounded-circle bg-label-secondary">3</span>
                            </div>
                            <small class="text-muted">Yeni Şifre</small>
                        </div>
                    </div>

                    <EditForm Model="IdentityModel" OnValidSubmit="VerifyIdentity">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label" for="tcKimlikNo">T.C. Kimlik Numarası</label>
                            <div class="input-group input-group-merge">
                                <span class="input-group-text"><i class="bx bx-id-card"></i></span>
                                <InputText @bind-Value="IdentityModel.TcKimlikNo"
                                           id="tcKimlikNo"
                                           class="form-control"
                                           placeholder="11 haneli TC Kimlik No"
                                           maxlength="11"
                                           autofocus />
                            </div>
                            <ValidationMessage For="@(() => IdentityModel.TcKimlikNo)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="sicilNo">Sicil Numarası</label>
                            <div class="input-group input-group-merge">
                                <span class="input-group-text"><i class="bx bx-hash"></i></span>
                                <InputText @bind-Value="IdentityModel.SicilNo"
                                           id="sicilNo"
                                           class="form-control"
                                           placeholder="Sicil numaranız" />
                            </div>
                            <ValidationMessage For="@(() => IdentityModel.SicilNo)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="dogumTarihi">Doğum Tarihi</label>
                            <div class="input-group input-group-merge">
                                <span class="input-group-text"><i class="bx bx-calendar"></i></span>
                                <InputDate @bind-Value="IdentityModel.DogumTarihi"
                                           id="dogumTarihi"
                                           class="form-control" />
                            </div>
                            <ValidationMessage For="@(() => IdentityModel.DogumTarihi)" class="text-danger small" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label" for="kayitliTelefon">Kayıtlı Telefon (Son 4 Hane)</label>
                            <div class="input-group input-group-merge">
                                <span class="input-group-text"><i class="bx bx-phone"></i></span>
                                <span class="input-group-text bg-light text-muted">*** *** **</span>
                                <InputText @bind-Value="IdentityModel.TelefonSon4Hane"
                                           id="kayitliTelefon"
                                           class="form-control"
                                           placeholder="XXXX"
                                           maxlength="4"
                                           style="max-width: 80px;" />
                            </div>
                            <small class="text-muted">Sistemde kayıtlı telefon numaranızın son 4 hanesi</small>
                            <ValidationMessage For="@(() => IdentityModel.TelefonSon4Hane)" class="text-danger small" />
                        </div>

                        <button type="submit" class="btn btn-primary d-grid w-100 mb-3" disabled="@IsSubmitting">
                            @if (IsSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Doğrulanıyor...</span>
                            }
                            else
                            {
                                <span>Doğrula ve Devam Et</span>
                            }
                        </button>

                        <div class="text-center">
                            <a href="/login" class="d-flex align-items-center justify-content-center text-decoration-none">
                                <i class="bx bx-chevron-left me-1"></i>
                                Giriş Sayfasına Dön
                            </a>
                        </div>
                    </EditForm>
                }
                else if (CurrentStep == Step.SecurityQuestion)
                {
                    <!-- Step 2: Security Question -->
                    <h4 class="mb-2 text-center">Güvenlik Sorusu</h4>
                    <p class="mb-4 text-center text-muted">
                        Kimliğinizi doğrulamak için güvenlik sorusunu yanıtlayın.
                    </p>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger d-flex align-items-center" role="alert">
                            <i class="bx bx-error-circle me-2"></i>
                            <span>@ErrorMessage</span>
                        </div>
                    }

                    <!-- Progress Steps -->
                    <div class="d-flex justify-content-between mb-4">
                        <div class="text-center flex-fill">
                            <div class="avatar avatar-sm mx-auto mb-1">
                                <span class="avatar-initial rounded-circle bg-success"><i class="bx bx-check"></i></span>
                            </div>
                            <small class="text-success fw-semibold">Kimlik Doğrulama</small>
                        </div>
                        <div class="text-center flex-fill">
                            <div class="avatar avatar-sm mx-auto mb-1">
                                <span class="avatar-initial rounded-circle bg-primary">2</span>
                            </div>
                            <small class="text-primary fw-semibold">Güvenlik Sorusu</small>
                        </div>
                        <div class="text-center flex-fill">
                            <div class="avatar avatar-sm mx-auto mb-1">
                                <span class="avatar-initial rounded-circle bg-label-secondary">3</span>
                            </div>
                            <small class="text-muted">Yeni Şifre</small>
                        </div>
                    </div>

                    <div class="alert alert-light mb-4">
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-3">
                                <span class="avatar-initial rounded bg-label-primary">
                                    <i class="bx bx-user"></i>
                                </span>
                            </div>
                            <div>
                                <h6 class="mb-0">@MaskedUserName</h6>
                                <small class="text-muted">@MaskedDepartment</small>
                            </div>
                        </div>
                    </div>

                    <EditForm Model="SecurityModel" OnValidSubmit="VerifySecurityAnswer">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">@SecurityQuestion</label>
                            <InputText @bind-Value="SecurityModel.Answer"
                                       class="form-control"
                                       placeholder="Yanıtınızı girin" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Anne Kızlık Soyadı (İlk 3 Harf)</label>
                            <InputText @bind-Value="SecurityModel.AnneKizlikSoyadi"
                                       class="form-control"
                                       placeholder="Örn: AYD"
                                       maxlength="3"
                                       style="text-transform: uppercase;" />
                            <small class="text-muted">Annenizin kızlık soyadının ilk 3 harfi</small>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary flex-fill" @onclick="GoBack">
                                <i class="bx bx-arrow-back me-1"></i> Geri
                            </button>
                            <button type="submit" class="btn btn-primary flex-fill" disabled="@IsSubmitting">
                                @if (IsSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                Doğrula
                            </button>
                        </div>
                    </EditForm>
                }
                else if (CurrentStep == Step.NewPassword)
                {
                    <!-- Step 3: Set New Password -->
                    <h4 class="mb-2 text-center">Yeni Şifre Belirleme</h4>
                    <p class="mb-4 text-center text-muted">
                        Yeni şifrenizi belirleyin.
                    </p>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger d-flex align-items-center" role="alert">
                            <i class="bx bx-error-circle me-2"></i>
                            <span>@ErrorMessage</span>
                        </div>
                    }

                    <!-- Progress Steps -->
                    <div class="d-flex justify-content-between mb-4">
                        <div class="text-center flex-fill">
                            <div class="avatar avatar-sm mx-auto mb-1">
                                <span class="avatar-initial rounded-circle bg-success"><i class="bx bx-check"></i></span>
                            </div>
                            <small class="text-success fw-semibold">Kimlik Doğrulama</small>
                        </div>
                        <div class="text-center flex-fill">
                            <div class="avatar avatar-sm mx-auto mb-1">
                                <span class="avatar-initial rounded-circle bg-success"><i class="bx bx-check"></i></span>
                            </div>
                            <small class="text-success fw-semibold">Güvenlik Sorusu</small>
                        </div>
                        <div class="text-center flex-fill">
                            <div class="avatar avatar-sm mx-auto mb-1">
                                <span class="avatar-initial rounded-circle bg-primary">3</span>
                            </div>
                            <small class="text-primary fw-semibold">Yeni Şifre</small>
                        </div>
                    </div>

                    <EditForm Model="PasswordModel" OnValidSubmit="SetNewPassword">
                        <div class="mb-3">
                            <label class="form-label">Yeni Şifre</label>
                            <div class="input-group input-group-merge">
                                <InputText @bind-Value="PasswordModel.NewPassword"
                                           type="@(ShowNewPassword ? "text" : "password")"
                                           class="form-control"
                                           placeholder="Yeni şifrenizi girin" />
                                <span class="input-group-text cursor-pointer" @onclick="() => ShowNewPassword = !ShowNewPassword">
                                    <i class="bx @(ShowNewPassword ? "bx-show" : "bx-hide")"></i>
                                </span>
                            </div>

                            <!-- Password Strength -->
                            <div class="mt-2">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-@PasswordStrengthColor" style="width: @PasswordStrengthPercent%"></div>
                                </div>
                                <small class="text-@PasswordStrengthColor">@PasswordStrengthText</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Şifre Tekrar</label>
                            <div class="input-group input-group-merge">
                                <InputText @bind-Value="PasswordModel.ConfirmPassword"
                                           type="@(ShowConfirmPassword ? "text" : "password")"
                                           class="form-control"
                                           placeholder="Şifrenizi tekrar girin" />
                                <span class="input-group-text cursor-pointer" @onclick="() => ShowConfirmPassword = !ShowConfirmPassword">
                                    <i class="bx @(ShowConfirmPassword ? "bx-show" : "bx-hide")"></i>
                                </span>
                            </div>
                            @if (!string.IsNullOrEmpty(PasswordModel.NewPassword) && !string.IsNullOrEmpty(PasswordModel.ConfirmPassword))
                            {
                                @if (PasswordModel.NewPassword == PasswordModel.ConfirmPassword)
                                {
                                    <small class="text-success"><i class="bx bx-check me-1"></i>Şifreler eşleşiyor</small>
                                }
                                else
                                {
                                    <small class="text-danger"><i class="bx bx-x me-1"></i>Şifreler eşleşmiyor</small>
                                }
                            }
                        </div>

                        <!-- Password Requirements -->
                        <div class="alert alert-light mb-4">
                            <small class="fw-semibold d-block mb-2">Şifre Gereksinimleri:</small>
                            <ul class="list-unstyled mb-0 small">
                                <li class="@(HasMinLength ? "text-success" : "text-muted")">
                                    <i class="bx @(HasMinLength ? "bx-check" : "bx-circle") me-1"></i>En az 8 karakter
                                </li>
                                <li class="@(HasUpperCase ? "text-success" : "text-muted")">
                                    <i class="bx @(HasUpperCase ? "bx-check" : "bx-circle") me-1"></i>Büyük harf (A-Z)
                                </li>
                                <li class="@(HasLowerCase ? "text-success" : "text-muted")">
                                    <i class="bx @(HasLowerCase ? "bx-check" : "bx-circle") me-1"></i>Küçük harf (a-z)
                                </li>
                                <li class="@(HasDigit ? "text-success" : "text-muted")">
                                    <i class="bx @(HasDigit ? "bx-check" : "bx-circle") me-1"></i>Rakam (0-9)
                                </li>
                            </ul>
                        </div>

                        <button type="submit" class="btn btn-primary d-grid w-100" disabled="@(IsSubmitting || !IsPasswordValid)">
                            @if (IsSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Kaydediliyor...</span>
                            }
                            else
                            {
                                <i class="bx bx-check me-1"></i>
                                <span>Şifreyi Kaydet</span>
                            }
                        </button>
                    </EditForm>
                }
                else if (CurrentStep == Step.Success)
                {
                    <!-- Success -->
                    <div class="text-center">
                        <div class="avatar avatar-lg mx-auto mb-4" style="width: 100px; height: 100px;">
                            <span class="avatar-initial rounded-circle bg-success" style="width: 100px; height: 100px; line-height: 100px; font-size: 3rem;">
                                <i class="bx bx-check"></i>
                            </span>
                        </div>

                        <h4 class="mb-2 text-success">Şifreniz Değiştirildi!</h4>
                        <p class="text-muted mb-4">
                            Şifreniz başarıyla güncellendi. Yeni şifrenizle giriş yapabilirsiniz.
                        </p>

                        <div class="alert alert-warning text-start mb-4">
                            <i class="bx bx-info-circle me-2"></i>
                            <small>Güvenliğiniz için şifrenizi kimseyle paylaşmayın ve düzenli aralıklarla değiştirin.</small>
                        </div>

                        <a href="/login" class="btn btn-primary d-grid w-100">
                            <i class="bx bx-log-in me-1"></i>
                            Giriş Sayfasına Git
                        </a>
                    </div>
                }

                <!-- Footer -->
                <div class="text-center mt-5">
                    <p class="small text-muted mb-0">
                        &copy; @DateTime.Now.Year SGK İzmir İl Müdürlüğü
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .authentication-wrapper {
        min-height: 100vh;
    }
    .authentication-bg {
        background-color: #fff;
    }
    .input-group-merge .input-group-text {
        border-right: none;
        background: transparent;
    }
    .input-group-merge .form-control {
        border-left: none;
    }
    .input-group-merge .form-control:focus {
        border-color: #696cff;
        box-shadow: none;
    }
    .input-group-merge:focus-within .input-group-text {
        border-color: #696cff;
    }
    .cursor-pointer {
        cursor: pointer;
    }
</style>
