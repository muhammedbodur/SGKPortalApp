@page "/pdks/zkteco/devices"
@using SGKPortalApp.BusinessObjectLayer.Entities.ZKTeco
@using System.Net.Http.Json
@inject HttpClient Http
@inject IConfiguration Configuration
@inject IJSRuntime JS
@inject NavigationManager Navigation

<PageTitle>ZKTeco Cihaz Y√∂netimi</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h3>üì± ZKTeco Cihaz Y√∂netimi</h3>
        </div>
    </div>

    @if (devices == null)
    {
        <p><em>Y√ºkleniyor...</em></p>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>Cihaz Adƒ±</th>
                        <th>IP:Port</th>
                        <th>Durum</th>
                        <th>Son Kontrol</th>
                        <th style="min-width: 400px;">ƒ∞≈ülemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var device in devices)
                    {
                        <tr>
                            <td><strong>@device.DeviceName</strong></td>
                            <td><code>@device.IpAddress:@device.Port</code></td>
                            <td>
                                <span class="badge @(device.IsActive ? "bg-success" : "bg-secondary")">
                                    @(device.IsActive ? "Aktif" : "Pasif")
                                </span>
                            </td>
                            <td><small>@device.LastHealthCheckTime?.ToString("dd.MM HH:mm")</small></td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-info" @onclick="() => TestConnection(device.Id)" title="Baƒülantƒ± Testi">
                                        <i class="bx bx-wifi"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" @onclick="() => GetStatus(device.Id)" title="Durum">
                                        <i class="bx bx-info-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" @onclick="() => GetDeviceTime(device.Id)" title="Cihaz Saati">
                                        <i class="bx bx-time"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" @onclick="() => SyncDeviceTime(device.Id)" title="Saati Senkronize Et">
                                        <i class="bx bx-sync"></i>
                                    </button>
                                    <button class="btn btn-outline-success" @onclick="() => ShowDeviceUsers(device.Id)" title="Cihazdaki Personeller">
                                        <i class="bx bx-group"></i>
                                    </button>
                                    <button class="btn btn-outline-dark" @onclick="() => RestartDevice(device.Id)" title="Yeniden Ba≈ülat">
                                        <i class="bx bx-revision"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" @onclick="() => Delete(device.Id)" title="Sil">
                                        <i class="bx bx-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<ZKTecoDevice>? devices;
    private string apiBaseUrl = "";

    protected override async Task OnInitializedAsync()
    {
        apiBaseUrl = Configuration["AppSettings:Urls:HttpsUrl"] ?? "https://localhost:9080";
        await LoadDevices();
    }

    private async Task LoadDevices()
    {
        devices = await Http.GetFromJsonAsync<List<ZKTecoDevice>>($"{apiBaseUrl}/api/ZKTecoDevice");
    }

    private async Task TestConnection(int deviceId)
    {
        var response = await Http.PostAsync($"{apiBaseUrl}/api/ZKTecoDevice/{deviceId}/test", null);
        var result = await response.Content.ReadFromJsonAsync<dynamic>();
        await JS.InvokeVoidAsync("alert", result?.Success == true ? "‚úÖ Baƒülantƒ± ba≈üarƒ±lƒ±!" : "‚ùå Baƒülantƒ± ba≈üarƒ±sƒ±z!");
        await LoadDevices();
    }

    private async Task GetStatus(int deviceId)
    {
        try
        {
            var status = await Http.GetFromJsonAsync<dynamic>($"{apiBaseUrl}/api/ZKTecoDevice/{deviceId}/status");
            var message = $"üìä Cihaz Durum Bilgisi:\n\n" +
                         $"Firmware: {status?.FirmwareVersion}\n" +
                         $"Seri No: {status?.SerialNumber}\n" +
                         $"Platform: {status?.Platform}\n" +
                         $"Kullanƒ±cƒ±: {status?.UserCount} / {status?.UserCapacity}\n" +
                         $"Kayƒ±t: {status?.AttendanceLogCount} / {status?.AttLogCapacity}\n" +
                         $"Parmak ƒ∞zi: {status?.FingerPrintCount} / {status?.FingerPrintCapacity}";
            await JS.InvokeVoidAsync("alert", message);
        }
        catch
        {
            await JS.InvokeVoidAsync("alert", "‚ùå Cihaz durumu alƒ±namadƒ±!");
        }
    }

    private async Task GetDeviceTime(int deviceId)
    {
        try
        {
            var timeDto = await Http.GetFromJsonAsync<dynamic>($"{apiBaseUrl}/api/ZKTecoDevice/{deviceId}/time");
            var deviceTime = DateTime.Parse(timeDto?.DeviceTime.ToString());
            var diff = timeDto?.TimeDifferenceSeconds;
            await JS.InvokeVoidAsync("alert", $"üïê Cihaz Saati:\n{deviceTime:dd.MM.yyyy HH:mm:ss}\n\nSunucu ile fark: {diff} saniye");
        }
        catch
        {
            await JS.InvokeVoidAsync("alert", "‚ùå Cihaz saati alƒ±namadƒ±!");
        }
    }

    private async Task SyncDeviceTime(int deviceId)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Cihaz saatini ≈üu anki sunucu saatiyle senkronize etmek istediƒüinize emin misiniz?"))
        {
            try
            {
                await Http.PostAsync($"{apiBaseUrl}/api/ZKTecoDevice/{deviceId}/time/sync", null);
                await JS.InvokeVoidAsync("alert", "‚úÖ Cihaz saati senkronize edildi!");
            }
            catch
            {
                await JS.InvokeVoidAsync("alert", "‚ùå Cihaz saati senkronize edilemedi!");
            }
        }
    }

    private async Task ShowDeviceUsers(int deviceId)
    {
        try
        {
            var users = await Http.GetFromJsonAsync<List<dynamic>>($"{apiBaseUrl}/api/ZKTecoUser/device/{deviceId}/from-device");
            if (users != null && users.Any())
            {
                await JS.InvokeVoidAsync("alert", $"üë• Cihazdaki Personel Sayƒ±sƒ±: {users.Count}\n\nDetaylƒ± liste i√ßin 'Kullanƒ±cƒ± Y√∂netimi' sayfasƒ±nƒ± ziyaret edin.");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "‚ÑπÔ∏è Cihazda kayƒ±tlƒ± personel bulunamadƒ±.");
            }
        }
        catch
        {
            await JS.InvokeVoidAsync("alert", "‚ùå Personel listesi alƒ±namadƒ±!");
        }
    }

    private async Task RestartDevice(int deviceId)
    {
        if (await JS.InvokeAsync<bool>("confirm", "‚ö†Ô∏è Cihazƒ± yeniden ba≈ülatmak istediƒüinize emin misiniz?\n\nCihaz yakla≈üƒ±k 30 saniye offline olacak."))
        {
            try
            {
                await Http.PostAsync($"{apiBaseUrl}/api/ZKTecoDevice/{deviceId}/restart", null);
                await JS.InvokeVoidAsync("alert", "‚úÖ Cihaz yeniden ba≈ülatƒ±lƒ±yor...");
            }
            catch
            {
                await JS.InvokeVoidAsync("alert", "‚ùå Cihaz yeniden ba≈ülatƒ±lamadƒ±!");
            }
        }
    }

    private async Task Delete(int deviceId)
    {
        if (await JS.InvokeAsync<bool>("confirm", "‚ö†Ô∏è Cihazƒ± silmek istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!"))
        {
            try
            {
                await Http.DeleteAsync($"{apiBaseUrl}/api/ZKTecoDevice/{deviceId}");
                await JS.InvokeVoidAsync("alert", "‚úÖ Cihaz silindi!");
                await LoadDevices();
            }
            catch
            {
                await JS.InvokeVoidAsync("alert", "‚ùå Cihaz silinemedi!");
            }
        }
    }
}
