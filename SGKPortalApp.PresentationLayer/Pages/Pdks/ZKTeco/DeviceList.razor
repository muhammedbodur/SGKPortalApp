@page "/pdks/zkteco/devices"
@using SGKPortalApp.BusinessObjectLayer.DTOs.Response.Common
@using SGKPortalApp.BusinessObjectLayer.DTOs.Request.ZKTeco
@using SGKPortalApp.BusinessObjectLayer.DTOs.Response.ZKTeco
@using SGKPortalApp.BusinessObjectLayer.DTOs.Shared.ZKTeco
@using SGKPortalApp.BusinessObjectLayer.Enums
@using SGKPortalApp.BusinessObjectLayer.Enums.ZKTeco
@inherits SGKPortalApp.PresentationLayer.Components.Base.FieldPermissionPageBase

<PageTitle>ZKTeco Cihaz YÃ¶netimi</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h3>ðŸ“± ZKTeco Cihaz YÃ¶netimi</h3>
            @if (devices != null)
            {
                var monitoringCount = devices.Count(d => d.IsMonitoring);
                <small class="text-muted">
                    Toplam: <strong>@devices.Count</strong> cihaz |
                    CanlÄ± Ä°zleme: <strong class="text-success">@monitoringCount</strong> cihaz
                </small>
            }
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary me-2" @onclick="CheckAllDeviceConnectionsAsync" disabled="@isCheckingConnections">
                @if (isCheckingConnections)
                {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                }
                else
                {
                    <i class="bx bx-refresh"></i>
                }
                BaÄŸlantÄ±larÄ± Kontrol Et
            </button>
            <button class="btn btn-primary" @onclick="ToggleAddForm">
                <i class="bx bx-plus"></i> @(showAddForm ? "Formu Kapat" : "Yeni Cihaz")
            </button>
        </div>
    </div>

    @if (showEditForm)
    {
        <div class="card mb-3 border-warning">
            <div class="card-body">
                <h5 class="card-title text-warning">
                    <i class="bx bx-edit"></i> Cihaz DÃ¼zenle
                </h5>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Departman *</label>
                        <select class="form-select" @onchange="OnDepartmanChanged" value="@selectedDepartmanId">
                            <option value="0">Departman SeÃ§in...</option>
                            @foreach (var departman in departmanlar)
                            {
                                <option value="@departman.DepartmanId">@departman.DepartmanAdi</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hizmet BinasÄ± *</label>
                        <select class="form-select" @bind="editDevice.HizmetBinasiId" disabled="@(selectedDepartmanId == 0)">
                            <option value="0">Hizmet BinasÄ± SeÃ§in...</option>
                            @foreach (var hizmetBinasi in hizmetBinalari)
                            {
                                <option value="@hizmetBinasi.HizmetBinasiId">@hizmetBinasi.HizmetBinasiAdi</option>
                            }
                        </select>
                        @if (selectedDepartmanId == 0)
                        {
                            <small class="text-muted">Ã–nce departman seÃ§in</small>
                        }
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cihaz AdÄ± *</label>
                        <input type="text" class="form-control" @bind="editDevice.DeviceName" placeholder="Ana GiriÅŸ KapÄ±sÄ±" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">IP Adresi *</label>
                        <input type="text" class="form-control" @bind="editDevice.IpAddress" placeholder="192.168.1.100" />
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-2">
                        <label class="form-label">Port</label>
                        <input type="text" class="form-control" @bind="editDevice.Port" placeholder="4370" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Cihaz Kodu</label>
                        <input type="text" class="form-control" @bind="editDevice.DeviceCode" placeholder="DEV001" />
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Aktif</label>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" @bind="editDevice.IsActive" />
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <button class="btn btn-warning" @onclick="UpdateDevice">
                            <i class="bx bx-save"></i> GÃ¼ncelle
                        </button>
                        <button class="btn btn-secondary ms-2" @onclick="() => showEditForm = false">Ä°ptal</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (showAddForm)
    {
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bx bx-plus"></i> Yeni Cihaz Ekle
                </h5>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Departman *</label>
                        <select class="form-select" @onchange="OnDepartmanChanged" value="@selectedDepartmanId">
                            <option value="0">Departman SeÃ§in...</option>
                            @foreach (var departman in departmanlar)
                            {
                                <option value="@departman.DepartmanId">@departman.DepartmanAdi</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hizmet BinasÄ± *</label>
                        <select class="form-select" @bind="newDevice.HizmetBinasiId" disabled="@(selectedDepartmanId == 0)">
                            <option value="0">Hizmet BinasÄ± SeÃ§in...</option>
                            @foreach (var hizmetBinasi in hizmetBinalari)
                            {
                                <option value="@hizmetBinasi.HizmetBinasiId">@hizmetBinasi.HizmetBinasiAdi</option>
                            }
                        </select>
                        @if (selectedDepartmanId == 0)
                        {
                            <small class="text-muted">Ã–nce departman seÃ§in</small>
                        }
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cihaz AdÄ± *</label>
                        <input type="text" class="form-control" @bind="newDevice.DeviceName" placeholder="Ana GiriÅŸ KapÄ±sÄ±" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">IP Adresi *</label>
                        <input type="text" class="form-control" @bind="newDevice.IpAddress" placeholder="192.168.1.100" />
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-2">
                        <label class="form-label">Port</label>
                        <input type="text" class="form-control" @bind="newDevice.Port" placeholder="4370" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Cihaz Kodu</label>
                        <input type="text" class="form-control" @bind="newDevice.DeviceCode" placeholder="DEV001" />
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Aktif</label>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" @bind="newDevice.IsActive" />
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <button class="btn btn-success" @onclick="SaveDevice">
                            <i class="bx bx-save"></i> Kaydet
                        </button>
                        <button class="btn btn-secondary ms-2" @onclick="ToggleAddForm">Ä°ptal</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">YÃ¼kleniyor...</span>
            </div>
            <p class="mt-3 text-muted">
                <strong>Cihazlar yÃ¼kleniyor ve baÄŸlantÄ± durumlarÄ± kontrol ediliyor...</strong>
            </p>
            @if (devices != null && devices.Any())
            {
                <small class="text-muted">
                    @devices.Count cihaz bulundu, baÄŸlantÄ±lar kontrol ediliyor...
                </small>
            }
        </div>
    }
    else if (devices == null || !devices.Any())
    {
        <div class="alert alert-info">
            <i class="bx bx-info-circle"></i> HenÃ¼z kayÄ±tlÄ± cihaz bulunmuyor.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>Cihaz AdÄ±</th>
                        <th>Departman</th>
                        <th>Hizmet BinasÄ±</th>
                        <th>IP:Port</th>
                        <th>BaÄŸlantÄ±</th>
                        <th>Durum</th>
                        <th>CanlÄ± Ä°zleme</th>
                        <th>Son Kontrol</th>
                        <th style="min-width: 400px;">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var device in devices)
                    {
                        <tr>
                            <td><strong>@device.DeviceName</strong></td>
                            <td>
                                @if (!string.IsNullOrEmpty(device.DepartmanAdi))
                                {
                                    <span class="badge bg-label-info">@device.DepartmanAdi</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(device.HizmetBinasiAdi))
                                {
                                    <span class="badge bg-label-primary">@device.HizmetBinasiAdi</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td><code>@device.IpAddress:@device.Port</code></td>
                            <td>
                                @{
                                    var connStatus = connectionStatus.ContainsKey(device.DeviceId) ? connectionStatus[device.DeviceId] : null;
                                }
                                @if (connStatus == null)
                                {
                                    <span class="badge bg-warning">
                                        <span class="spinner-border spinner-border-sm me-1" style="width: 0.8rem; height: 0.8rem;"></span>
                                        Kontrol Ediliyor
                                    </span>
                                }
                                else if (connStatus == true)
                                {
                                    <span class="badge bg-success">
                                        <i class="bx bx-wifi"></i> Online
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">
                                        <i class="bx bx-wifi-off"></i> Offline
                                    </span>
                                }
                            </td>
                            <td>
                                <span class="badge @(device.IsActive ? "bg-success" : "bg-secondary")">
                                    @(device.IsActive ? "Aktif" : "Pasif")
                                </span>
                            </td>
                            <td>
                                @if (device.IsMonitoring)
                                {
                                    <span class="badge bg-success">
                                        <i class="bx bx-broadcast"></i> Ä°zleniyor
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">
                                        <i class="bx bx-pause-circle"></i> Durduruldu
                                    </span>
                                }
                            </td>
                            <td><small>@device.LastHealthCheckTime?.ToString("dd.MM HH:mm")</small></td>
                            <td>
                                @{
                                    var isLoading = loadingStates.ContainsKey(device.DeviceId) && loadingStates[device.DeviceId];
                                }
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- DÃ¼zenle -->
                                    <button class="btn btn-outline-warning" @onclick="() => ToggleEditForm(device.DeviceId)" disabled="@isLoading" title="DÃ¼zenle">
                                        <i class="bx bx-edit"></i>
                                    </button>

                                    <!-- BaÄŸlantÄ± Testi -->
                                    <button class="btn btn-outline-info" @onclick="() => TestConnection(device.DeviceId)" disabled="@isLoading" title="BaÄŸlantÄ± Testi">
                                        @if (isLoading) { <span class="spinner-border spinner-border-sm"></span> } else { <i class="bx bx-wifi"></i> }
                                    </button>

                                    <!-- CanlÄ± Ä°zleme Toggle -->
                                    @if (device.IsMonitoring)
                                    {
                                        <button class="btn btn-warning" @onclick="() => StopRealtimeMonitoring(device.DeviceId)" disabled="@isLoading" title="CanlÄ± Ä°zlemeyi Durdur">
                                            @if (isLoading) { <span class="spinner-border spinner-border-sm"></span> } else { <i class="bx bx-stop-circle"></i> }
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-outline-success" @onclick="() => StartRealtimeMonitoring(device.DeviceId)" disabled="@isLoading" title="CanlÄ± Ä°zlemeyi BaÅŸlat">
                                            @if (isLoading) { <span class="spinner-border spinner-border-sm"></span> } else { <i class="bx bx-play-circle"></i> }
                                        </button>
                                    }

                                    <!-- Cihaz Ä°ÅŸlemleri Dropdown -->
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" disabled="@isLoading" title="Cihaz Ä°ÅŸlemleri">
                                            <i class="bx bx-cog"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" @onclick="() => GetStatus(device.DeviceId)"><i class="bx bx-info-circle me-2"></i>Durum Bilgisi</a></li>
                                            <li><a class="dropdown-item" @onclick="() => GetDeviceTime(device.DeviceId)"><i class="bx bx-time me-2"></i>Cihaz Saati</a></li>
                                            <li><a class="dropdown-item" @onclick="() => SyncDeviceTime(device.DeviceId)"><i class="bx bx-sync me-2"></i>Saati Senkronize Et</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" @onclick="() => EnableDevice(device.DeviceId)"><i class="bx bx-check-circle me-2"></i>EtkinleÅŸtir</a></li>
                                            <li><a class="dropdown-item" @onclick="() => DisableDevice(device.DeviceId)"><i class="bx bx-x-circle me-2"></i>Devre DÄ±ÅŸÄ± BÄ±rak</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-warning" @onclick="() => RestartDevice(device.DeviceId)"><i class="bx bx-revision me-2"></i>Yeniden BaÅŸlat</a></li>
                                            <li><a class="dropdown-item text-danger" @onclick="() => PowerOffDevice(device.DeviceId)"><i class="bx bx-power-off me-2"></i>Kapat</a></li>
                                        </ul>
                                    </div>

                                    <!-- Personel Ä°ÅŸlemleri Dropdown -->
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" disabled="@isLoading" title="Personel Ä°ÅŸlemleri">
                                            <i class="bx bx-group"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" @onclick="() => ShowDeviceUsers(device.DeviceId)"><i class="bx bx-list-ul me-2"></i>Cihazdaki Personeller</a></li>
                                            <li><a class="dropdown-item" @onclick="() => OpenSendPersonelModal(device.DeviceId)"><i class="bx bx-user-plus me-2"></i>Personel GÃ¶nder</a></li>
                                        </ul>
                                    </div>

                                    <!-- Sil -->
                                    <button class="btn btn-outline-danger" @onclick="() => Delete(device.DeviceId)" disabled="@isLoading" title="Sil">
                                        <i class="bx bx-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SEND PERSONEL MODAL -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
@if (showSendPersonelModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <h5 class="modal-title text-white">
                        <i class="bx bx-user-plus me-2"></i>Personel GÃ¶nder - @selectedDeviceName
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseSendPersonelModal"></button>
                </div>
                <div class="modal-body">
                    @if (isLoadingPersonel)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">YÃ¼kleniyor...</span>
                            </div>
                            <p class="mt-2 text-muted">Personeller yÃ¼kleniyor...</p>
                        </div>
                    }
                    else
                    {
                        <!-- Arama ve Toplu SeÃ§im -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bx bx-search"></i>
                                    </span>
                                    <input type="text"
                                           class="form-control"
                                           placeholder="Ad, Sicil veya TC ile ara..."
                                           @bind="personelSearchTerm"
                                           @bind:event="oninput" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary w-100" @onclick="ToggleSelectAllPersonel">
                                    <i class="bx @(IsAllPersonelSelected() ? "bx-checkbox-checked" : "bx-checkbox") me-1"></i>
                                    @(IsAllPersonelSelected() ? "TÃ¼mÃ¼nÃ¼n SeÃ§imini KaldÄ±r" : "TÃ¼mÃ¼nÃ¼ SeÃ§")
                                </button>
                            </div>
                        </div>

                        <!-- SeÃ§im Bilgisi -->
                        @if (selectedPersonelIds.Any())
                        {
                            <div class="alert alert-info mb-3">
                                <i class="bx bx-info-circle me-2"></i>
                                <strong>@selectedPersonelIds.Count</strong> personel seÃ§ildi
                            </div>
                        }

                        <!-- Personel Listesi -->
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox"
                                                   class="form-check-input"
                                                   checked="@IsAllPersonelSelected()"
                                                   @onchange="ToggleSelectAllPersonel" />
                                        </th>
                                        <th>Sicil No</th>
                                        <th>TC Kimlik No</th>
                                        <th>Ad Soyad</th>
                                        <th>Departman</th>
                                        <th>PDKS KayÄ±t No</th>
                                        <th>Kart No</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (!filteredPersonelList.Any())
                                    {
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-4">
                                                <i class="bx bx-search-alt bx-lg"></i>
                                                <p class="mb-0 mt-2">Personel bulunamadÄ±</p>
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (var personel in filteredPersonelList)
                                        {
                                            var isSelected = selectedPersonelIds.Contains(personel.TcKimlikNo);
                                            <tr class="@(isSelected ? "table-active" : "")"
                                                style="cursor: pointer;"
                                                @onclick="() => TogglePersonelSelection(personel.TcKimlikNo)">
                                                <td>
                                                    <input type="checkbox"
                                                           class="form-check-input"
                                                           checked="@isSelected"
                                                           @onclick:stopPropagation="true"
                                                           @onchange="() => TogglePersonelSelection(personel.TcKimlikNo)" />
                                                </td>
                                                <td><span class="badge bg-label-secondary">@personel.SicilNo</span></td>
                                                <td><small>@personel.TcKimlikNo</small></td>
                                                <td><strong>@personel.AdSoyad</strong></td>
                                                <td><small class="text-muted">@personel.DepartmanAdi</small></td>
                                                <td><span class="badge bg-label-info">@personel.PersonelKayitNo</span></td>
                                                <td>
                                                    @if (personel.KartNo > 0)
                                                    {
                                                        <span class="badge bg-label-primary">@personel.KartNo</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" @onclick="CloseSendPersonelModal" disabled="@isSendingPersonel">
                        Ä°ptal
                    </button>
                    <button type="button"
                            class="btn btn-primary"
                            @onclick="SendSelectedPersonelToDevice"
                            disabled="@(!selectedPersonelIds.Any() || isSendingPersonel)">
                        @if (isSendingPersonel)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bx bx-send me-1"></i>SeÃ§ili Personelleri GÃ¶nder (@selectedPersonelIds.Count)
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- DEVICE PERSONEL MODAL -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
@if (showDevicePersonelModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-success">
                    <h5 class="modal-title text-white">
                        <i class="bx bx-group me-2"></i>Cihazdaki Personeller - @selectedDeviceName
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseDevicePersonelModal"></button>
                </div>
                <div class="modal-body">
                    @if (isLoadingDevicePersonel)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">YÃ¼kleniyor...</span>
                            </div>
                            <p class="mt-2 text-muted">Cihazdan personel listesi alÄ±nÄ±yor...</p>
                        </div>
                    }
                    else
                    {
                        <!-- Arama -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bx bx-search"></i>
                                    </span>
                                    <input type="text"
                                           class="form-control"
                                           placeholder="Ad, KayÄ±t No veya Kart No ile ara..."
                                           @bind="devicePersonelSearchTerm"
                                           @bind:event="oninput" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-danger w-100"
                                        @onclick="DeleteSelectedUsers"
                                        disabled="@(!selectedUserEnrollNumbers.Any() || isLoadingDevicePersonel)">
                                    @if (isLoadingDevicePersonel)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    else
                                    {
                                        <i class="bx bx-trash me-1"></i>
                                    }
                                    SeÃ§ilileri Sil (@selectedUserEnrollNumbers.Count)
                                </button>
                            </div>
                            <div class="col-md-3">
                                <div class="alert alert-info mb-0 py-2">
                                    <i class="bx bx-info-circle me-2"></i>
                                    <strong>@filteredDevicePersonelList.Count</strong> / @devicePersonelList.Count personel
                                </div>
                            </div>
                        </div>

                        <!-- Personel Listesi -->
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox"
                                                   class="form-check-input"
                                                   @bind="selectAllUsers"
                                                   @onclick="ToggleSelectAll" />
                                        </th>
                                        <th style="width: 50px;">Durum</th>
                                        <th style="width: 100px;">KayÄ±t No</th>
                                        <th>Ad Soyad</th>
                                        <th>Cihazdaki NickName</th>
                                        <th>DB deki (NickName)</th>
                                        <th style="width: 120px;">Kart No</th>
                                        <th style="width: 100px;">DB Kart No</th>
                                        <th style="width: 100px;">Privilege</th>
                                        <th style="width: 100px;">Enabled</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (!filteredDevicePersonelList.Any())
                                    {
                                        <tr>
                                            <td colspan="9" class="text-center text-muted py-4">
                                                <i class="bx bx-search-alt bx-lg"></i>
                                                <p class="mb-0 mt-2">
                                                    @if (!devicePersonelList.Any())
                                                    {
                                                        <text>Cihazda kayÄ±tlÄ± personel bulunamadÄ±</text>
                                                    }
                                                    else
                                                    {
                                                        <text>Arama sonucu bulunamadÄ±</text>
                                                    }
                                                </p>
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (var match in filteredDevicePersonelList)
                                        {
                                            var hasMismatch = match.Mismatches.Any();
                                            var rowClass = hasMismatch ? "table-warning" : "";
                                            var enrollMismatch = match.Mismatches.FirstOrDefault(m => m.Type == MismatchType.EnrollNumberMismatch);
                                            var nameMismatch = match.Mismatches.FirstOrDefault(m => m.Type == MismatchType.NameMismatch);
                                            var cardMismatch = match.Mismatches.FirstOrDefault(m => m.Type == MismatchType.CardNumberMismatch);
                                            var notInDb = match.Status == MatchStatus.DeviceOnly;
                                            var enrollNumber = match.DeviceUser?.EnrollNumber ?? "";

                                            <tr class="@rowClass">
                                                <td class="text-center">
                                                    @if (!string.IsNullOrEmpty(enrollNumber))
                                                    {
                                                        <input type="checkbox"
                                                               class="form-check-input"
                                                               checked="@selectedUserEnrollNumbers.Contains(enrollNumber)"
                                                               @onclick="() => ToggleUserSelection(enrollNumber)" />
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    @if (notInDb)
                                                    {
                                                        <span class="badge bg-danger" title="VeritabanÄ±nda bulunamadÄ±">
                                                            <i class="bx bx-error"></i>
                                                        </span>
                                                    }
                                                    else if (hasMismatch)
                                                    {
                                                        <span class="badge bg-warning" title="@string.Join(", ", match.Mismatches.Select(m => m.Description))">
                                                            <i class="bx bx-error-circle"></i>
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-success" title="Uyumlu">
                                                            <i class="bx bx-check"></i>
                                                        </span>
                                                    }
                                                </td>
                                                <td>
                                                    <span class="badge @(enrollMismatch != null ? "bg-danger" : "bg-label-secondary")">
                                                        @match.DeviceUser?.EnrollNumber
                                                    </span>
                                                    @if (enrollMismatch != null)
                                                    {
                                                        <br/><small class="text-danger">DB: @enrollMismatch.PersonelValue</small>
                                                    }
                                                </td>
                                                <td>
                                                    @if (match.PersonelInfo != null)
                                                    {
                                                        <strong class="@(nameMismatch != null ? "text-danger" : "text-muted")">
                                                            @(match.PersonelInfo.AdSoyad ?? "-")
                                                        </strong>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Yok</span>
                                                    }
                                                </td>
                                                <td>
                                                    <strong class="@(nameMismatch != null ? "text-danger" : "")">
                                                        @match.DeviceUser?.Name
                                                    </strong>
                                                </td>
                                                <td>
                                                    @if (match.PersonelInfo != null)
                                                    {
                                                        <small class="@(nameMismatch != null ? "text-danger" : "text-muted")">
                                                            @(match.PersonelInfo.NickName ?? "-")
                                                        </small>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Yok</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (match.DeviceUser?.CardNumber.HasValue == true && match.DeviceUser.CardNumber.Value > 0)
                                                    {
                                                        <span class="badge @(cardMismatch != null ? "bg-danger" : "bg-primary")">
                                                            @match.DeviceUser.CardNumber.Value
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (match.PersonelInfo != null)
                                                    {
                                                        @if (match.PersonelInfo.KartNo > 0)
                                                        {
                                                            <span class="badge @(cardMismatch != null ? "bg-danger" : "bg-label-info")">
                                                                @match.PersonelInfo.KartNo
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (match.DeviceUser != null)
                                                    {
                                                        @switch (match.DeviceUser.Privilege)
                                                        {
                                                            case 0:
                                                                <span class="badge bg-label-secondary">User</span>
                                                                break;
                                                            case 14:
                                                                <span class="badge bg-label-warning">Admin</span>
                                                                break;
                                                            default:
                                                                <span class="badge bg-label-info">@match.DeviceUser.Privilege</span>
                                                                break;
                                                        }
                                                    }
                                                </td>
                                                <td>
                                                    @if (match.DeviceUser?.Enabled == true)
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="bx bx-check"></i> Aktif
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">
                                                            <i class="bx bx-x"></i> Pasif
                                                        </span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDevicePersonelModal">
                        <i class="bx bx-x me-1"></i>Kapat
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- DEVICE TIME MODAL -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
@if (showDeviceTimeModal && selectedDeviceTimeInfo != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="modal-title text-white">
                        <i class="bx bx-time me-2"></i>Cihaz Saati - @selectedDeviceName
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showDeviceTimeModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bx bx-devices me-1"></i>Cihaz Saati
                                    </h6>
                                    <h4 class="mb-0">@selectedDeviceTimeInfo.DeviceTime.ToString("dd.MM.yyyy HH:mm:ss")</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card border-success">
                                <div class="card-body">
                                    <h6 class="card-title text-success">
                                        <i class="bx bx-server me-1"></i>Sunucu Saati
                                    </h6>
                                    <h4 class="mb-0">@selectedDeviceTimeInfo.ServerTime.ToString("dd.MM.yyyy HH:mm:ss")</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="alert @(Math.Abs(selectedDeviceTimeInfo.TimeDifferenceSeconds) > 60 ? "alert-danger" : Math.Abs(selectedDeviceTimeInfo.TimeDifferenceSeconds) > 10 ? "alert-warning" : "alert-success") mb-0">
                                <h6 class="alert-heading">
                                    <i class="bx @(Math.Abs(selectedDeviceTimeInfo.TimeDifferenceSeconds) > 60 ? "bx-error-circle" : Math.Abs(selectedDeviceTimeInfo.TimeDifferenceSeconds) > 10 ? "bx-info-circle" : "bx-check-circle") me-1"></i>
                                    Zaman FarkÄ±
                                </h6>
                                <p class="mb-0">
                                    <strong>@selectedDeviceTimeInfo.TimeDifferenceSeconds saniye</strong>
                                    @if (Math.Abs(selectedDeviceTimeInfo.TimeDifferenceSeconds) > 60)
                                    {
                                        <span class="d-block mt-2">
                                            <i class="bx bx-error me-1"></i>Cihaz saati ile sunucu saati arasÄ±nda bÃ¼yÃ¼k fark var! Senkronizasyon Ã¶nerilir.
                                        </span>
                                    }
                                    else if (Math.Abs(selectedDeviceTimeInfo.TimeDifferenceSeconds) > 10)
                                    {
                                        <span class="d-block mt-2">
                                            <i class="bx bx-info-circle me-1"></i>Cihaz saati ile sunucu saati arasÄ±nda kÃ¼Ã§Ã¼k bir fark var.
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="d-block mt-2">
                                            <i class="bx bx-check me-1"></i>Cihaz saati sunucu saati ile senkron.
                                        </span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showDeviceTimeModal = false">
                        <i class="bx bx-x me-1"></i>Kapat
                    </button>
                </div>
            </div>
        </div>
    </div>
}
