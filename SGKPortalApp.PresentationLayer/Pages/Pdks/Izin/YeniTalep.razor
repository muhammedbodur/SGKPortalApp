@page "/pdks/izin/yeni-talep"
@using SGKPortalApp.BusinessObjectLayer.DTOs.Request.PdksIslemleri
@using SGKPortalApp.BusinessObjectLayer.Enums.PdksIslemleri
@inherits SGKPortalApp.PresentationLayer.Components.Base.FieldPermissionPageBase

<PageTitle>Yeni Ä°zin/Mazeret Talebi</PageTitle>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/pdks/izin/taleplerim">Taleplerim</a></li>
                    <li class="breadcrumb-item active">Yeni Talep</li>
                </ol>
            </nav>
            <h3>ğŸ“ Yeni Ä°zin/Mazeret Talebi</h3>
            <p class="text-muted">Ä°zin veya mazeret talebinizi oluÅŸturun</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <EditForm Model="@request" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />

                        <!-- Ä°zin/Mazeret TÃ¼rÃ¼ -->
                        <div class="mb-3">
                            <label class="form-label">Ä°zin/Mazeret TÃ¼rÃ¼ <span class="text-danger">*</span></label>
                            <select class="form-select @(showTurError ? "is-invalid" : "")"
                                    value="@selectedTuru" @onchange="OnTuruChanged">
                                <option value="">SeÃ§iniz...</option>
                                @foreach (IzinMazeretTuru tur in Enum.GetValues(typeof(IzinMazeretTuru)))
                                {
                                    <option value="@((int)tur)">@tur.GetDescription()</option>
                                }
                            </select>
                            @if (showTurError)
                            {
                                <div class="invalid-feedback">Ä°zin/Mazeret tÃ¼rÃ¼ seÃ§melisiniz</div>
                            }
                        </div>

                        @if (selectedTuru.HasValue)
                        {
                            var tur = (IzinMazeretTuru)selectedTuru.Value;

                            @if (tur == IzinMazeretTuru.Mazeret)
                            {
                                <!-- Mazeret iÃ§in: Tarih + Saat Dilimi -->
                                <div class="mb-3">
                                    <label class="form-label">Mazeret Tarihi <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" @bind="request.MazeretTarihi" />
                                    <ValidationMessage For="@(() => request.MazeretTarihi)" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Saat Dilimi <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" @bind="request.SaatDilimi"
                                           placeholder="Ã–rn: 09:00-10:00" />
                                    <ValidationMessage For="@(() => request.SaatDilimi)" />
                                    <small class="form-text text-muted">Mazeret gÃ¶sterdiÄŸiniz saat aralÄ±ÄŸÄ±nÄ± girin</small>
                                </div>
                            }
                            else
                            {
                                <!-- Ä°zin iÃ§in: BaÅŸlangÄ±Ã§ + BitiÅŸ Tarihi -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">BaÅŸlangÄ±Ã§ Tarihi <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control"
                                               value="@(request.BaslangicTarihi?.ToString("yyyy-MM-dd"))"
                                               @onchange="@(e => { request.BaslangicTarihi = DateTime.TryParse(e.Value?.ToString(), out var d) ? d : (DateTime?)null; CalculateDays(); })" />
                                        <ValidationMessage For="@(() => request.BaslangicTarihi)" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">BitiÅŸ Tarihi <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control"
                                               value="@(request.BitisTarihi?.ToString("yyyy-MM-dd"))"
                                               @onchange="@(e => { request.BitisTarihi = DateTime.TryParse(e.Value?.ToString(), out var d) ? d : (DateTime?)null; CalculateDays(); })" />
                                        <ValidationMessage For="@(() => request.BitisTarihi)" />
                                    </div>
                                </div>

                                @if (toplamGun > 0)
                                {
                                    <div class="alert alert-info">
                                        <i class="bx bx-info-circle"></i> <strong>Toplam GÃ¼n:</strong> @toplamGun gÃ¼n
                                    </div>
                                }
                            }

                            <!-- AÃ§Ä±klama -->
                            <div class="mb-3">
                                <label class="form-label">AÃ§Ä±klama</label>
                                <textarea class="form-control" rows="4" @bind="request.Aciklama"
                                          placeholder="Ä°zin/Mazeret sebebinizi aÃ§Ä±klayÄ±n..."></textarea>
                                <ValidationMessage For="@(() => request.Aciklama)" />
                            </div>

                            <!-- Belge Eki (Opsiyonel) -->
                            <div class="mb-3">
                                <label class="form-label">Belge Eki (Opsiyonel)</label>
                                <input type="file" class="form-control" @onchange="HandleFileSelected" />
                                <small class="form-text text-muted">Rapor, evlilik cÃ¼zdanÄ± vb. belge ekleyebilirsiniz</small>
                            </div>

                            <!-- Ã‡akÄ±ÅŸma UyarÄ±sÄ± -->
                            @if (!string.IsNullOrEmpty(overlapWarning))
                            {
                                <div class="alert alert-warning">
                                    <i class="bx bx-error"></i> @overlapWarning
                                </div>
                            }

                            <!-- Buttons -->
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-secondary"
                                        @onclick="CheckOverlap" disabled="@isChecking">
                                    @if (isChecking)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    else
                                    {
                                        <i class="bx bx-search me-1"></i>
                                    }
                                    Ã‡akÄ±ÅŸma KontrolÃ¼
                                </button>
                                <button type="submit" class="btn btn-success" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    else
                                    {
                                        <i class="bx bx-save me-1"></i>
                                    }
                                    Talep OluÅŸtur
                                </button>
                                <a href="/pdks/izin/taleplerim" class="btn btn-outline-secondary">
                                    <i class="bx bx-x me-1"></i> Ä°ptal
                                </a>
                            </div>
                        }

                    </EditForm>
                </div>
            </div>
        </div>

        <!-- YardÄ±m KartÄ± -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bx bx-help-circle me-1"></i> YardÄ±m</h5>
                </div>
                <div class="card-body">
                    <h6>Ä°zin TÃ¼rleri:</h6>
                    <ul class="small">
                        <li><strong>YÄ±llÄ±k Ä°zin:</strong> YÄ±llÄ±k izin hakkÄ±nÄ±zdan kullanÄ±m</li>
                        <li><strong>HastalÄ±k Ä°zni:</strong> Rapor ile belgelendirilir</li>
                        <li><strong>BabalÄ±k Ä°zni:</strong> 5 gÃ¼n Ã¼cretli izin</li>
                        <li><strong>Evlilik Ä°zni:</strong> 3 gÃ¼n Ã¼cretli izin</li>
                        <li><strong>Mazeret:</strong> GeÃ§ kalma, erken Ã§Ä±kÄ±ÅŸ gibi durumlar</li>
                    </ul>

                    <hr />

                    <h6>Onay SÃ¼reci:</h6>
                    <ol class="small">
                        <li>Talep oluÅŸturulur</li>
                        <li>1. Onayci deÄŸerlendirir</li>
                        <li>2. Onayci deÄŸerlendirir</li>
                        <li>Her iki onay sonrasÄ± kesinleÅŸir</li>
                    </ol>

                    <hr />

                    <p class="small text-muted mb-0">
                        <i class="bx bx-info-circle"></i> Ã‡akÄ±ÅŸan tarih aralÄ±klarÄ±nda talep oluÅŸturamazsÄ±nÄ±z.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
