using SGKPortalApp.BusinessObjectLayer.Entities.Common;
using SGKPortalApp.BusinessObjectLayer.Entities.SiramatikIslemleri;
using SGKPortalApp.BusinessObjectLayer.Enums.SiramatikIslemleri;
using SGKPortalApp.PresentationLayer.Services.ApiServices.Interfaces.SignalR;
using SGKPortalApp.PresentationLayer.Services.Hubs.Interfaces;

namespace SGKPortalApp.PresentationLayer.Services.Hubs.Concrete
{
    /// <summary>
    /// Hub Connection Service (Wrapper - Layered Architecture)
    /// SignalR Hub â†’ HubConnectionService â†’ HubConnectionApiService â†’ API â†’ Business â†’ Data
    /// 
    /// Bu servis SignalR Hub'lar iÃ§in bir wrapper gÃ¶revi gÃ¶rÃ¼r.
    /// TÃ¼m iÅŸlemler HubConnectionApiService Ã¼zerinden API'ye yÃ¶nlendirilir.
    /// </summary>
    public class HubConnectionService : IHubConnectionService
    {
        private readonly IHubConnectionApiService _apiService;
        private readonly ILogger<HubConnectionService> _logger;

        public HubConnectionService(
            IHubConnectionApiService apiService, 
            ILogger<HubConnectionService> logger)
        {
            _apiService = apiService;
            _logger = logger;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CORE CONNECTION MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        public async Task<bool> CreateOrUpdateUserConnectionAsync(string connectionId, string tcKimlikNo)
            => await _apiService.CreateOrUpdateUserConnectionAsync(connectionId, tcKimlikNo);

        public async Task<bool> DisconnectAsync(string connectionId)
            => await _apiService.DisconnectAsync(connectionId);

        public async Task<List<HubConnection>> GetActiveConnectionsByTcKimlikNoAsync(string tcKimlikNo)
            => await _apiService.GetActiveConnectionsByTcKimlikNoAsync(tcKimlikNo);

        public async Task<HubConnection?> GetByConnectionIdAsync(string connectionId)
            => await _apiService.GetByConnectionIdAsync(connectionId);

        public async Task<bool> UpdateConnectionTypeAsync(string connectionId, string connectionType)
            => await _apiService.UpdateConnectionTypeAsync(connectionId, connectionType);

        public async Task<bool> SetConnectionStatusAsync(string connectionId, string status)
            => await _apiService.SetConnectionStatusAsync(connectionId, status);

        public async Task<bool> RegisterUserConnectionAsync(string connectionId, string tcKimlikNo, string connectionType)
            => await _apiService.CreateOrUpdateUserConnectionAsync(connectionId, tcKimlikNo);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BANKO CONNECTION MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        public async Task<bool> RegisterBankoConnectionAsync(int bankoId, string connectionId, string tcKimlikNo)
            => await _apiService.RegisterBankoConnectionAsync(bankoId, connectionId, tcKimlikNo);

        public async Task<bool> RegisterBankoConnectionAsync(int bankoId, string connectionId, ConnectionStatus status)
            => await _apiService.RegisterBankoConnectionAsync(bankoId, connectionId, "");

        public async Task<bool> UnregisterBankoConnectionAsync(int bankoId, string connectionId)
            => await _apiService.DeactivateBankoConnectionAsync("");

        public async Task<bool> DeactivateBankoConnectionAsync(string tcKimlikNo)
            => await _apiService.DeactivateBankoConnectionAsync(tcKimlikNo);

        public async Task<bool> IsBankoInUseAsync(int bankoId)
            => await _apiService.IsBankoInUseAsync(bankoId);

        public async Task<bool> IsBankoConnectedAsync(int bankoId)
            => await _apiService.IsBankoInUseAsync(bankoId);

        public async Task<HubBankoConnection?> GetPersonelActiveBankoAsync(string tcKimlikNo)
            => await _apiService.GetPersonelActiveBankoAsync(tcKimlikNo);

        public async Task<User?> GetBankoActivePersonelAsync(int bankoId)
            => await _apiService.GetBankoActivePersonelAsync(bankoId);

        public async Task<int?> GetBankoIdByConnectionIdAsync(string connectionId)
            => throw new NotImplementedException("API endpoint eklenecek");

        public async Task<string?> GetConnectionIdByBankoIdAsync(int bankoId)
            => throw new NotImplementedException("API endpoint eklenecek");

        public async Task<Dictionary<int, string>> GetAllActiveBankoConnectionsAsync()
            => throw new NotImplementedException("API endpoint eklenecek");

        public async Task<HubBankoConnection?> GetBankoConnectionByHubConnectionIdAsync(int hubConnectionId)
            => throw new NotImplementedException("API endpoint eklenecek");

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TV CONNECTION MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        public async Task<bool> RegisterTvConnectionAsync(int tvId, string connectionId, string tcKimlikNo)
            => await _apiService.RegisterTvConnectionAsync(tvId, connectionId, tcKimlikNo);

        public async Task<bool> RegisterTvConnectionAsync(int tvId, string connectionId)
            => await _apiService.RegisterTvConnectionAsync(tvId, connectionId, "");

        public async Task<bool> RegisterTvConnectionAsync(int tvId, string connectionId, ConnectionStatus status)
            => await _apiService.RegisterTvConnectionAsync(tvId, connectionId, "");

        public async Task<bool> UnregisterTvConnectionAsync(int tvId, string connectionId)
            => throw new NotImplementedException("API endpoint eklenecek");

        public async Task<bool> IsTvInUseByTvUserAsync(int tvId)
            => await _apiService.IsTvInUseByTvUserAsync(tvId);

        public async Task<bool> IsTvConnectedAsync(int tvId)
            => await _apiService.IsTvInUseByTvUserAsync(tvId);

        public async Task<int?> GetTvIdByConnectionIdAsync(string connectionId)
            => throw new NotImplementedException("API endpoint eklenecek");

        public async Task<string?> GetConnectionIdByTvIdAsync(int tvId)
            => throw new NotImplementedException("API endpoint eklenecek");

        public async Task<Dictionary<int, string>> GetAllActiveConnectionsAsync()
            => throw new NotImplementedException("API endpoint eklenecek");

        public async Task<HubTvConnection?> GetTvConnectionByHubConnectionIdAsync(int hubConnectionId)
            => throw new NotImplementedException("API endpoint eklenecek");

        public async Task<bool> UpdateConnectionStatusAsync(string connectionId, ConnectionStatus status)
            => await _apiService.SetConnectionStatusAsync(connectionId, status.ToString());

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TV CONNECTION MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /// <summary>
        /// TV baÄŸlantÄ±sÄ±nÄ± kaydet veya gÃ¼ncelle
        /// âš ï¸ TV iÃ§in User ZORUNLU (TV oluÅŸturulurken otomatik oluÅŸturulur)
        /// </summary>
        public async Task<bool> RegisterTvConnectionAsync(int tvId, string connectionId, ConnectionStatus status)
        {
            try
            {
                // 1. TV'yi ve User'Ä±nÄ± bul
                var tv = await _context.Tvler.FirstOrDefaultAsync(t => t.TvId == tvId);
                if (tv == null)
                {
                    _logger.LogWarning($"âŒ TV bulunamadÄ±: {tvId}");
                    return false;
                }

                // 2. TV iÃ§in User kontrolÃ¼ (TV User zorunlu)
                if (string.IsNullOrEmpty(tv.TcKimlikNo))
                {
                    _logger.LogError($"âŒ TV iÃ§in User oluÅŸturulmamÄ±ÅŸ: TV#{tvId}");
                    _logger.LogError("ğŸ’¡ Ä°pucu: TV oluÅŸturulurken otomatik User oluÅŸturulmalÄ±");
                    return false;
                }

                // 3. HubConnection oluÅŸtur veya gÃ¼ncelle (TV User'Ä± ile)
                var hubConnection = await GetOrCreateHubConnectionAsync(connectionId, tcKimlikNo: tv.TcKimlikNo);

                // 3. Mevcut TV baÄŸlantÄ±sÄ±nÄ± kontrol et
                var existingTvConnection = await _context.HubTvConnections
                    .FirstOrDefaultAsync(htc => htc.TvId == tvId);

                if (existingTvConnection != null)
                {
                    // GÃ¼ncelle
                    existingTvConnection.HubConnectionId = hubConnection.HubConnectionId;
                    existingTvConnection.IslemZamani = DateTime.Now;
                    existingTvConnection.DuzenlenmeTarihi = DateTime.Now;
                    
                    _context.HubTvConnections.Update(existingTvConnection);
                    _logger.LogInformation($"âœï¸ TV baÄŸlantÄ±sÄ± gÃ¼ncellendi: TV#{tvId}");
                }
                else
                {
                    // Yeni kayÄ±t oluÅŸtur
                    var newTvConnection = new HubTvConnection
                    {
                        HubConnectionId = hubConnection.HubConnectionId,
                        TvId = tvId,
                        IslemZamani = DateTime.Now,
                        EklenmeTarihi = DateTime.Now,
                        DuzenlenmeTarihi = DateTime.Now
                    };

                    await _context.HubTvConnections.AddAsync(newTvConnection);
                    _logger.LogInformation($"â• Yeni TV baÄŸlantÄ±sÄ± kaydedildi: TV#{tvId}");
                }

                await _context.SaveChangesAsync();
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ TV baÄŸlantÄ±sÄ± kaydedilemedi: TV#{tvId}");
                return false;
            }
        }

        /// <summary>
        /// TV baÄŸlantÄ±sÄ±nÄ± kaldÄ±r
        /// </summary>
        public async Task<bool> UnregisterTvConnectionAsync(int tvId, string connectionId)
        {
            try
            {
                var tvConnection = await _context.HubTvConnections
                    .Include(htc => htc.HubConnection)
                    .FirstOrDefaultAsync(htc => htc.TvId == tvId && 
                                                htc.HubConnection != null && 
                                                htc.HubConnection.ConnectionId == connectionId);

                if (tvConnection != null)
                {
                    // Soft delete
                    tvConnection.SilindiMi = true;
                    tvConnection.DuzenlenmeTarihi = DateTime.Now;
                    
                    // HubConnection'Ä± da offline yap
                    if (tvConnection.HubConnection != null)
                    {
                        tvConnection.HubConnection.ConnectionStatus = ConnectionStatus.offline;
                        tvConnection.HubConnection.IslemZamani = DateTime.Now;
                        tvConnection.HubConnection.DuzenlenmeTarihi = DateTime.Now;
                    }
                    
                    await _context.SaveChangesAsync();
                    
                    _logger.LogInformation($"ğŸ”´ TV baÄŸlantÄ±sÄ± kaldÄ±rÄ±ldÄ±: TV#{tvId}");
                    return true;
                }

                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ TV baÄŸlantÄ±sÄ± kaldÄ±rÄ±lamadÄ±: TV#{tvId}");
                return false;
            }
        }

        /// <summary>
        /// TV'nin baÄŸlantÄ± durumunu kontrol et
        /// </summary>
        public async Task<bool> IsTvConnectedAsync(int tvId)
        {
            try
            {
                var tvConnection = await _context.HubTvConnections
                    .Include(htc => htc.HubConnection)
                    .FirstOrDefaultAsync(htc => htc.TvId == tvId);

                return tvConnection != null && 
                       tvConnection.HubConnection != null && 
                       tvConnection.HubConnection.ConnectionStatus == ConnectionStatus.online;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ TV baÄŸlantÄ± durumu kontrol edilemedi: TV#{tvId}");
                return false;
            }
        }

        /// <summary>
        /// ConnectionId'ye gÃ¶re TV ID'sini al
        /// </summary>
        public async Task<int?> GetTvIdByConnectionIdAsync(string connectionId)
        {
            try
            {
                var tvConnection = await _context.HubTvConnections
                    .Include(htc => htc.HubConnection)
                    .FirstOrDefaultAsync(htc => htc.HubConnection != null && 
                                                htc.HubConnection.ConnectionId == connectionId);

                return tvConnection?.TvId;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ ConnectionId'ye gÃ¶re TV ID alÄ±namadÄ±: {connectionId}");
                return null;
            }
        }

        /// <summary>
        /// TV'nin connection ID'sini al
        /// </summary>
        public async Task<string?> GetConnectionIdByTvIdAsync(int tvId)
        {
            try
            {
                var tvConnection = await _context.HubTvConnections
                    .Include(htc => htc.HubConnection)
                    .FirstOrDefaultAsync(htc => htc.TvId == tvId && 
                                                htc.HubConnection != null && 
                                                htc.HubConnection.ConnectionStatus == ConnectionStatus.online);

                return tvConnection?.HubConnection?.ConnectionId;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ TV ID'ye gÃ¶re ConnectionId alÄ±namadÄ±: TV#{tvId}");
                return null;
            }
        }

        /// <summary>
        /// TÃ¼m aktif TV baÄŸlantÄ±larÄ±nÄ± al
        /// </summary>
        public async Task<Dictionary<int, string>> GetAllActiveConnectionsAsync()
        {
            try
            {
                var connections = await _context.HubTvConnections
                    .Include(htc => htc.HubConnection)
                    .Where(htc => htc.HubConnection != null && 
                                  htc.HubConnection.ConnectionStatus == ConnectionStatus.online)
                    .ToDictionaryAsync(htc => htc.TvId, 
                                      htc => htc.HubConnection!.ConnectionId);

                return connections;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "âŒ Aktif TV baÄŸlantÄ±larÄ± alÄ±namadÄ±");
                return new Dictionary<int, string>();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BANKO CONNECTION MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /// <summary>
        /// Banko baÄŸlantÄ±sÄ±nÄ± kaydet veya gÃ¼ncelle
        /// âš ï¸ GÃœVENLÄ°K: Banko iÃ§in User ZORUNLU (TcKimlikNo null olamaz)
        /// </summary>
        public async Task<bool> RegisterBankoConnectionAsync(int bankoId, string connectionId, ConnectionStatus status)
        {
            try
            {
                // 1. Banko'nun var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                var bankoExists = await _context.Bankolar.AnyAsync(b => b.BankoId == bankoId);
                if (!bankoExists)
                {
                    _logger.LogWarning($"âŒ Banko bulunamadÄ±: {bankoId}");
                    return false;
                }

                // 2. HubConnection'Ä± bul
                var hubConnection = await _context.HubConnections
                    .FirstOrDefaultAsync(hc => hc.ConnectionId == connectionId);

                if (hubConnection == null)
                {
                    _logger.LogError($"âŒ HubConnection bulunamadÄ±: {connectionId}");
                    _logger.LogError("ğŸ’¡ Ä°pucu: Ã–nce kullanÄ±cÄ± login olmalÄ± ve HubConnection oluÅŸturulmalÄ±");
                    return false;
                }

                // 3. âš ï¸ NOT: TcKimlikNo artÄ±k veritabanÄ± seviyesinde zorunlu (required constraint)
                //     Ekstra kontrol gerekmez, zaten null olamaz

                // 4. Mevcut Banko baÄŸlantÄ±sÄ±nÄ± kontrol et
                var existingBankoConnection = await _context.HubBankoConnections
                    .FirstOrDefaultAsync(hbc => hbc.BankoId == bankoId);

                if (existingBankoConnection != null)
                {
                    // GÃ¼ncelle
                    existingBankoConnection.HubConnectionId = hubConnection.HubConnectionId;
                    existingBankoConnection.IslemZamani = DateTime.Now;
                    existingBankoConnection.DuzenlenmeTarihi = DateTime.Now;
                    
                    _context.HubBankoConnections.Update(existingBankoConnection);
                    _logger.LogInformation($"âœï¸ Banko baÄŸlantÄ±sÄ± gÃ¼ncellendi: Banko#{bankoId} (User: {hubConnection.TcKimlikNo})");
                }
                else
                {
                    // Yeni kayÄ±t oluÅŸtur
                    var newBankoConnection = new HubBankoConnection
                    {
                        HubConnectionId = hubConnection.HubConnectionId,
                        BankoId = bankoId,
                        IslemZamani = DateTime.Now,
                        EklenmeTarihi = DateTime.Now,
                        DuzenlenmeTarihi = DateTime.Now
                    };

                    await _context.HubBankoConnections.AddAsync(newBankoConnection);
                    _logger.LogInformation($"â• Yeni Banko baÄŸlantÄ±sÄ± kaydedildi: Banko#{bankoId} (User: {hubConnection.TcKimlikNo})");
                }

                await _context.SaveChangesAsync();
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Banko baÄŸlantÄ±sÄ± kaydedilemedi: Banko#{bankoId}");
                return false;
            }
        }

        /// <summary>
        /// Banko baÄŸlantÄ±sÄ±nÄ± kaldÄ±r
        /// </summary>
        public async Task<bool> UnregisterBankoConnectionAsync(int bankoId, string connectionId)
        {
            try
            {
                var bankoConnection = await _context.HubBankoConnections
                    .Include(hbc => hbc.HubConnection)
                    .FirstOrDefaultAsync(hbc => hbc.BankoId == bankoId && 
                                                hbc.HubConnection != null && 
                                                hbc.HubConnection.ConnectionId == connectionId);

                if (bankoConnection != null)
                {
                    // Soft delete
                    bankoConnection.SilindiMi = true;
                    bankoConnection.DuzenlenmeTarihi = DateTime.Now;
                    
                    // HubConnection'Ä± da offline yap
                    if (bankoConnection.HubConnection != null)
                    {
                        bankoConnection.HubConnection.ConnectionStatus = ConnectionStatus.offline;
                        bankoConnection.HubConnection.IslemZamani = DateTime.Now;
                        bankoConnection.HubConnection.DuzenlenmeTarihi = DateTime.Now;
                    }
                    
                    await _context.SaveChangesAsync();
                    
                    _logger.LogInformation($"ğŸ”´ Banko baÄŸlantÄ±sÄ± kaldÄ±rÄ±ldÄ±: Banko#{bankoId}");
                    return true;
                }

                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Banko baÄŸlantÄ±sÄ± kaldÄ±rÄ±lamadÄ±: Banko#{bankoId}");
                return false;
            }
        }

        /// <summary>
        /// Banko'nun baÄŸlantÄ± durumunu kontrol et
        /// </summary>
        public async Task<bool> IsBankoConnectedAsync(int bankoId)
        {
            try
            {
                var bankoConnection = await _context.HubBankoConnections
                    .Include(hbc => hbc.HubConnection)
                    .FirstOrDefaultAsync(hbc => hbc.BankoId == bankoId);

                return bankoConnection != null && 
                       bankoConnection.HubConnection != null && 
                       bankoConnection.HubConnection.ConnectionStatus == ConnectionStatus.online;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Banko baÄŸlantÄ± durumu kontrol edilemedi: Banko#{bankoId}");
                return false;
            }
        }

        /// <summary>
        /// ConnectionId'ye gÃ¶re Banko ID'sini al
        /// </summary>
        public async Task<int?> GetBankoIdByConnectionIdAsync(string connectionId)
        {
            try
            {
                var bankoConnection = await _context.HubBankoConnections
                    .Include(hbc => hbc.HubConnection)
                    .FirstOrDefaultAsync(hbc => hbc.HubConnection != null && 
                                                hbc.HubConnection.ConnectionId == connectionId);

                return bankoConnection?.BankoId;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ ConnectionId'ye gÃ¶re Banko ID alÄ±namadÄ±: {connectionId}");
                return null;
            }
        }

        /// <summary>
        /// Banko'nun connection ID'sini al
        /// </summary>
        public async Task<string?> GetConnectionIdByBankoIdAsync(int bankoId)
        {
            try
            {
                var bankoConnection = await _context.HubBankoConnections
                    .Include(hbc => hbc.HubConnection)
                    .FirstOrDefaultAsync(hbc => hbc.BankoId == bankoId && 
                                                hbc.HubConnection != null && 
                                                hbc.HubConnection.ConnectionStatus == ConnectionStatus.online);

                return bankoConnection?.HubConnection?.ConnectionId;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Banko ID'ye gÃ¶re ConnectionId alÄ±namadÄ±: Banko#{bankoId}");
                return null;
            }
        }

        /// <summary>
        /// TÃ¼m aktif banko baÄŸlantÄ±larÄ±nÄ± al
        /// </summary>
        public async Task<Dictionary<int, string>> GetAllActiveBankoConnectionsAsync()
        {
            try
            {
                var connections = await _context.HubBankoConnections
                    .Include(hbc => hbc.HubConnection)
                    .Where(hbc => hbc.HubConnection != null && 
                                  hbc.HubConnection.ConnectionStatus == ConnectionStatus.online)
                    .ToDictionaryAsync(hbc => hbc.BankoId, 
                                      hbc => hbc.HubConnection!.ConnectionId);

                return connections;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "âŒ Aktif banko baÄŸlantÄ±larÄ± alÄ±namadÄ±");
                return new Dictionary<int, string>();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GENERIC CONNECTION MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /// <summary>
        /// BaÄŸlantÄ± durumunu gÃ¼ncelle
        /// </summary>
        public async Task<bool> UpdateConnectionStatusAsync(string connectionId, ConnectionStatus status)
        {
            try
            {
                var hubConnection = await _context.HubConnections
                    .FirstOrDefaultAsync(hc => hc.ConnectionId == connectionId);

                if (hubConnection != null)
                {
                    hubConnection.ConnectionStatus = status;
                    hubConnection.IslemZamani = DateTime.Now;
                    hubConnection.DuzenlenmeTarihi = DateTime.Now;
                    
                    _context.HubConnections.Update(hubConnection);
                    await _context.SaveChangesAsync();
                    
                    _logger.LogInformation($"âœï¸ BaÄŸlantÄ± durumu gÃ¼ncellendi: {connectionId} -> {status}");
                    return true;
                }

                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ BaÄŸlantÄ± durumu gÃ¼ncellenemedi: {connectionId}");
                return false;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MULTI-CONNECTION MANAGEMENT (Yeni YapÄ±)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /// <summary>
        /// KullanÄ±cÄ±nÄ±n tÃ¼m aktif baÄŸlantÄ±larÄ±nÄ± getir (TcKimlikNo bazÄ±nda)
        /// </summary>
        public async Task<List<HubConnection>> GetActiveConnectionsByTcKimlikNoAsync(string tcKimlikNo)
        {
            try
            {
                return await _context.HubConnections
                    .Where(hc => hc.TcKimlikNo == tcKimlikNo && 
                                 hc.ConnectionStatus == ConnectionStatus.online)
                    .ToListAsync();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Aktif baÄŸlantÄ±lar alÄ±namadÄ±: {tcKimlikNo}");
                return new List<HubConnection>();
            }
        }

        /// <summary>
        /// Banko baÅŸka personel tarafÄ±ndan kullanÄ±lÄ±yor mu?
        /// </summary>
        public async Task<bool> IsBankoInUseAsync(int bankoId)
        {
            try
            {
                return await _context.HubBankoConnections
                    .AnyAsync(hbc => hbc.BankoId == bankoId && 
                                     hbc.BankoModuAktif);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Banko kullanÄ±m durumu kontrol edilemedi: Banko#{bankoId}");
                return false;
            }
        }

        /// <summary>
        /// Personelin aktif banko oturumunu getir
        /// </summary>
        public async Task<HubBankoConnection?> GetPersonelActiveBankoAsync(string tcKimlikNo)
        {
            try
            {
                return await _context.HubBankoConnections
                    .FirstOrDefaultAsync(hbc => hbc.TcKimlikNo == tcKimlikNo && 
                                                hbc.BankoModuAktif);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Personel banko oturumu alÄ±namadÄ±: {tcKimlikNo}");
                return null;
            }
        }

        /// <summary>
        /// Banko oturumu oluÅŸtur (Fiziksel bankoya geÃ§iÅŸ) - OVERLOAD
        /// </summary>
        public async Task<bool> RegisterBankoConnectionAsync(int bankoId, string connectionId, string tcKimlikNo)
        {
            try
            {
                // 1. HubConnection'Ä± bul
                var hubConnection = await _context.HubConnections
                    .FirstOrDefaultAsync(hc => hc.ConnectionId == connectionId);

                if (hubConnection == null)
                {
                    _logger.LogError($"âŒ HubConnection bulunamadÄ±: {connectionId}");
                    return false;
                }

                // 2. Yeni banko oturumu oluÅŸtur
                var bankoConnection = new HubBankoConnection
                {
                    HubConnectionId = hubConnection.HubConnectionId,
                    BankoId = bankoId,
                    TcKimlikNo = tcKimlikNo,
                    BankoModuAktif = true,
                    BankoModuBaslangic = DateTime.Now,
                    IslemZamani = DateTime.Now,
                    EklenmeTarihi = DateTime.Now,
                    DuzenlenmeTarihi = DateTime.Now
                };

                await _context.HubBankoConnections.AddAsync(bankoConnection);
                await _context.SaveChangesAsync();

                _logger.LogInformation($"âœ… Banko oturumu oluÅŸturuldu: Banko#{bankoId} - {tcKimlikNo}");
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Banko oturumu oluÅŸturulamadÄ±: Banko#{bankoId}");
                return false;
            }
        }

        /// <summary>
        /// Banko oturumunu kapat (Banko modundan Ã§Ä±kÄ±ÅŸ)
        /// </summary>
        public async Task<bool> DeactivateBankoConnectionAsync(string tcKimlikNo)
        {
            try
            {
                var bankoConnection = await _context.HubBankoConnections
                    .FirstOrDefaultAsync(hbc => hbc.TcKimlikNo == tcKimlikNo && 
                                                hbc.BankoModuAktif);

                if (bankoConnection != null)
                {
                    bankoConnection.BankoModuAktif = false;
                    bankoConnection.BankoModuBitis = DateTime.Now;
                    bankoConnection.DuzenlenmeTarihi = DateTime.Now;

                    _context.HubBankoConnections.Update(bankoConnection);
                    await _context.SaveChangesAsync();

                    _logger.LogInformation($"âœ… Banko oturumu kapatÄ±ldÄ±: Banko#{bankoConnection.BankoId} - {tcKimlikNo}");
                    return true;
                }

                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Banko oturumu kapatÄ±lamadÄ±: {tcKimlikNo}");
                return false;
            }
        }

        /// <summary>
        /// BaÄŸlantÄ± tipini gÃ¼ncelle (MainLayout, TvDisplay, BankoMode)
        /// </summary>
        public async Task<bool> UpdateConnectionTypeAsync(string connectionId, string connectionType)
        {
            try
            {
                var hubConnection = await _context.HubConnections
                    .FirstOrDefaultAsync(hc => hc.ConnectionId == connectionId);

                if (hubConnection != null)
                {
                    hubConnection.ConnectionType = connectionType;
                    hubConnection.DuzenlenmeTarihi = DateTime.Now;

                    _context.HubConnections.Update(hubConnection);
                    await _context.SaveChangesAsync();

                    _logger.LogInformation($"âœ… BaÄŸlantÄ± tipi gÃ¼ncellendi: {connectionId} -> {connectionType}");
                    return true;
                }

                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ BaÄŸlantÄ± tipi gÃ¼ncellenemedi: {connectionId}");
                return false;
            }
        }

        /// <summary>
        /// BaÄŸlantÄ± durumunu gÃ¼ncelle (online, offline, reconnecting)
        /// </summary>
        public async Task<bool> SetConnectionStatusAsync(string connectionId, string status)
        {
            try
            {
                var hubConnection = await _context.HubConnections
                    .FirstOrDefaultAsync(hc => hc.ConnectionId == connectionId);

                if (hubConnection != null)
                {
                    // String'i enum'a Ã§evir
                    if (Enum.TryParse<ConnectionStatus>(status, true, out var connectionStatus))
                    {
                        hubConnection.ConnectionStatus = connectionStatus;
                        hubConnection.LastActivityAt = DateTime.Now;
                        hubConnection.DuzenlenmeTarihi = DateTime.Now;

                        _context.HubConnections.Update(hubConnection);
                        await _context.SaveChangesAsync();

                        _logger.LogInformation($"âœ… BaÄŸlantÄ± durumu gÃ¼ncellendi: {connectionId} -> {status}");
                        return true;
                    }
                }

                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ BaÄŸlantÄ± durumu gÃ¼ncellenemedi: {connectionId}");
                return false;
            }
        }

        /// <summary>
        /// ConnectionId ile HubConnection getir
        /// </summary>
        public async Task<HubConnection?> GetByConnectionIdAsync(string connectionId)
        {
            try
            {
                return await _context.HubConnections
                    .FirstOrDefaultAsync(hc => hc.ConnectionId == connectionId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ HubConnection alÄ±namadÄ±: {connectionId}");
                return null;
            }
        }

        /// <summary>
        /// BaÄŸlantÄ±yÄ± tamamen kapat ve sil
        /// </summary>
        public async Task<bool> DisconnectAsync(string connectionId)
        {
            try
            {
                var hubConnection = await _context.HubConnections
                    .Include(hc => hc.HubTvConnection)
                    .Include(hc => hc.HubBankoConnection)
                    .FirstOrDefaultAsync(hc => hc.ConnectionId == connectionId);

                if (hubConnection != null)
                {
                    // Soft delete
                    hubConnection.SilindiMi = true;
                    hubConnection.ConnectionStatus = ConnectionStatus.offline;
                    hubConnection.DuzenlenmeTarihi = DateTime.Now;

                    // Ä°liÅŸkili TV ve Banko baÄŸlantÄ±larÄ±nÄ± da sil
                    if (hubConnection.HubTvConnection != null)
                    {
                        hubConnection.HubTvConnection.SilindiMi = true;
                        hubConnection.HubTvConnection.DuzenlenmeTarihi = DateTime.Now;
                    }

                    if (hubConnection.HubBankoConnection != null)
                    {
                        hubConnection.HubBankoConnection.SilindiMi = true;
                        hubConnection.HubBankoConnection.BankoModuAktif = false;
                        hubConnection.HubBankoConnection.BankoModuBitis = DateTime.Now;
                        hubConnection.HubBankoConnection.DuzenlenmeTarihi = DateTime.Now;
                    }

                    _context.HubConnections.Update(hubConnection);
                    await _context.SaveChangesAsync();

                    _logger.LogInformation($"âœ… BaÄŸlantÄ± kapatÄ±ldÄ±: {connectionId}");
                    return true;
                }

                return false;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ BaÄŸlantÄ± kapatÄ±lamadÄ±: {connectionId}");
                return false;
            }
        }

        /// <summary>
        /// TV baÄŸlantÄ±sÄ±nÄ± kaydet (Yeni yapÄ± - birden fazla kullanÄ±cÄ±) - OVERLOAD
        /// </summary>
        public async Task<bool> RegisterTvConnectionAsync(int tvId, string connectionId)
        {
            try
            {
                // 1. HubConnection'Ä± bul
                var hubConnection = await _context.HubConnections
                    .FirstOrDefaultAsync(hc => hc.ConnectionId == connectionId);

                if (hubConnection == null)
                {
                    _logger.LogError($"âŒ HubConnection bulunamadÄ±: {connectionId}");
                    return false;
                }

                // 2. Yeni TV baÄŸlantÄ±sÄ± oluÅŸtur
                var tvConnection = new HubTvConnection
                {
                    HubConnectionId = hubConnection.HubConnectionId,
                    TvId = tvId,
                    IslemZamani = DateTime.Now,
                    EklenmeTarihi = DateTime.Now,
                    DuzenlenmeTarihi = DateTime.Now
                };

                await _context.HubTvConnections.AddAsync(tvConnection);
                await _context.SaveChangesAsync();

                _logger.LogInformation($"âœ… TV baÄŸlantÄ±sÄ± oluÅŸturuldu: TV#{tvId} - {connectionId}");
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ TV baÄŸlantÄ±sÄ± oluÅŸturulamadÄ±: TV#{tvId}");
                return false;
            }
        }

        /// <summary>
        /// TV baÅŸka bir TV User tarafÄ±ndan kullanÄ±lÄ±yor mu?
        /// </summary>
        public async Task<bool> IsTvInUseByTvUserAsync(int tvId)
        {
            try
            {
                // TV User'Ä±n TcKimlikNo'su "TV" ile baÅŸlar
                return await _context.HubTvConnections
                    .Include(htc => htc.HubConnection)
                    .AnyAsync(htc => htc.TvId == tvId && 
                                     htc.HubConnection != null &&
                                     htc.HubConnection.TcKimlikNo.StartsWith("TV") &&
                                     htc.HubConnection.ConnectionStatus == ConnectionStatus.online);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ TV kullanÄ±m durumu kontrol edilemedi: TV#{tvId}");
                return false;
            }
        }

        /// <summary>
        /// HubConnectionId ile HubBankoConnection getir
        /// </summary>
        public async Task<HubBankoConnection?> GetBankoConnectionByHubConnectionIdAsync(int hubConnectionId)
        {
            try
            {
                return await _context.HubBankoConnections
                    .FirstOrDefaultAsync(hbc => hbc.HubConnectionId == hubConnectionId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ HubBankoConnection alÄ±namadÄ±: {hubConnectionId}");
                return null;
            }
        }

        /// <summary>
        /// HubConnectionId ile HubTvConnection getir
        /// </summary>
        public async Task<HubTvConnection?> GetTvConnectionByHubConnectionIdAsync(int hubConnectionId)
        {
            try
            {
                return await _context.HubTvConnections
                    .FirstOrDefaultAsync(htc => htc.HubConnectionId == hubConnectionId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ HubTvConnection alÄ±namadÄ±: {hubConnectionId}");
                return null;
            }
        }

        /// <summary>
        /// Bankodaki aktif personeli getir
        /// </summary>
        public async Task<User?> GetBankoActivePersonelAsync(int bankoId)
        {
            try
            {
                var bankoConnection = await _context.HubBankoConnections
                    .Include(hbc => hbc.HubConnection)
                    .ThenInclude(hc => hc!.User)
                    .FirstOrDefaultAsync(hbc => hbc.BankoId == bankoId && 
                                                hbc.BankoModuAktif);

                return bankoConnection?.HubConnection?.User;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ Banko personeli alÄ±namadÄ±: Banko#{bankoId}");
                return null;
            }
        }

        /// <summary>
        /// KullanÄ±cÄ± iÃ§in yeni baÄŸlantÄ± oluÅŸtur (ConnectionType ile)
        /// </summary>
        public async Task<bool> RegisterUserConnectionAsync(string connectionId, string tcKimlikNo, string connectionType)
        {
            try
            {
                // Yeni baÄŸlantÄ± oluÅŸtur
                var hubConnection = new HubConnection
                {
                    TcKimlikNo = tcKimlikNo,
                    ConnectionId = connectionId,
                    ConnectionType = connectionType,
                    ConnectionStatus = ConnectionStatus.online,
                    ConnectedAt = DateTime.Now,
                    LastActivityAt = DateTime.Now,
                    IslemZamani = DateTime.Now,
                    EklenmeTarihi = DateTime.Now,
                    DuzenlenmeTarihi = DateTime.Now
                };

                await _context.HubConnections.AddAsync(hubConnection);
                await _context.SaveChangesAsync();

                _logger.LogInformation($"âœ… Yeni baÄŸlantÄ± oluÅŸturuldu: {connectionId} ({connectionType}) - {tcKimlikNo}");
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"âŒ BaÄŸlantÄ± oluÅŸturulamadÄ±: {connectionId}");
                return false;
            }
        }
    }
}
